{
  "results": {
    "CNTR_1740787713_1760756870012": {
      "testId": "CNTR_1740787713_1760756870012",
      "timestamp": "2025-10-18T03:07:50.012Z",
      "query": "escalation for Duplicate container snapshot detected: Data quality monitor detected that container CMAU0000020 was inserted twice within one second, creating inconsistent yard inventory views.",
      "aiResponse": "Subject: Escalation: ALR-861600 - Duplicate Container Snapshot (CMAU0000020)\n\nLeadership,\n\nIncident ALR-861600 reports a duplicate snapshot for container CMAU",
      "module": "CNTR",
      "expectedOutcome": null,
      "results": {
        "procedureCompliance": {
          "score": 70,
          "issues": [
            "Missing required step: validate container status",
            "Missing required step: check location data",
            "Missing required step: verify ownership"
          ],
          "category": "procedure_compliance"
        },
        "accuracyCheck": {
          "score": 85,
          "issues": [
            "Missing container status check"
          ],
          "category": "accuracy"
        },
        "safetyValidation": {
          "score": 50,
          "issues": [
            "Missing safety consideration: proper documentation",
            "Missing safety consideration: verification steps"
          ],
          "category": "safety"
        },
        "completenessCheck": {
          "score": 100,
          "issues": [],
          "category": "completeness"
        },
        "clarityScore": {
          "score": 100,
          "issues": [],
          "category": "clarity"
        }
      },
      "overallScore": 81,
      "passed": true
    },
    "CNTR_1336769417_1760759682779": {
      "testId": "CNTR_1336769417_1760759682779",
      "timestamp": "2025-10-18T03:54:42.779Z",
      "query": "playbook for Duplicate container snapshot detected: Data quality monitor detected that container CMAU0000020 was inserted twice within one second, creating inconsistent yard inventory views.",
      "aiResponse": "Portwarden AI Playbook: ALR-861600 - Duplicate Container Snapshot Detected\n\n**Incident:** ALR-861600 - Duplicate container snapshot detected (Medium)\n**Container ID:** CMAU0000020\n**Summary:** Data quality monitor detected that container CMAU0000020 was inserted twice within one second, creating inconsistent yard inventory views.\n**Reference:** [KB-2210] CNTR: Duplicate Container information received\n\n---\n\n**Objective:** Resolve duplicate container snapshot for CMAU0000020, ensure data consistency, and restore accurate inventory views.\n\n**Action Steps:**\n\n1.  **Acknowledge and Review Incident Details**\n    *   Confirm the alert details match the provided context.\n    *   Review `container_service.log` for the `WARN container-version DuplicateSnapshotAttempt cntr_no=CMAU0000020` entry to confirm the exact timestamp and context of the duplication event.\n\n2.  **Detect Duplicate Snapshots (Initial Verification)**\n    *   Query the `container` database table to identify all entries for `CMAU0000020`, specifically looking for multiple records with identical or near-identical timestamps that indicate a duplicate snapshot. This aligns with [KB-2210] Action 1.\n\n    ```sql\n    SQL Query: Retrieve Duplicate Candidates\n    SELECT\n        id,\n        cntr_no,\n        location,\n        status,\n        snapshot_timestamp,\n        created_at\n    FROM\n        container_snapshots\n    WHERE\n        cntr_no = 'CMAU0000020'\n    ORDER BY\n        snapshot_timestamp DESC, created_at DESC;\n    ```\n    *   **Verification:** Confirm that multiple rows exist for `CMAU0000020` with very close `snapshot_timestamp` values, as indicated by the alert. Identify the primary key (`id`) for all duplicate entries.\n\n3.  **Retain Most Recent Snapshot Only**\n    *   Identify the single most recent and correct snapshot for `CMAU0000020` based on `snapshot_timestamp` and `created_at`. All other duplicate entries for this container must be archived or removed. This aligns with [KB-2210] Action 2.\n    *   **Safety Precaution:** Before proceeding, perform a backup of the affected rows or the entire `container_snapshots` table if policy dictates.\n\n    ```sql\n    SQL Query: Identify and Archive/Delete Duplicate Rows (Example - Adapt to your archiving policy)\n    -- Step 3a: Identify the ID of the most recent valid snapshot\n    SELECT id INTO @latest_id\n    FROM container_snapshots\n    WHERE cntr_no = 'CMAU0000020'\n    ORDER BY snapshot_timestamp DESC, created_at DESC\n    LIMIT 1;\n\n    -- Step 3b: Archive/Delete all other snapshots for CMAU0000020\n    -- OPTION A: Archive to a history table (Recommended for auditability)\n    INSERT INTO container_snapshots_history\n    SELECT *\n    FROM container_snapshots\n    WHERE cntr_no = 'CMAU0000020' AND id != @latest_id;\n\n    -- OPTION B: Delete directly (Use with extreme caution and only if archiving is not an option)\n    DELETE FROM container_snapshots\n    WHERE cntr_no = 'CMAU0000020' AND id != @latest_id;\n    ```\n    *   **Verification:** Execute the initial `SELECT` query from Step 2 again. Confirm that only one row for `CMAU0000020` remains in the `container_snapshots` table, and it is the intended most recent snapshot.\n\n4.  **Rebuild Cache Consumers**\n    *   Trigger a refresh or rebuild of the relevant cache consumers that rely on container snapshot data. This ensures downstream systems and APIs receive the corrected, single snapshot for `CMAU0000020`. This aligns with [KB-2210] Action 3.\n\n    ```api\n    API Call: Trigger Cache Refresh (Example - Adjust endpoint and payload as per system design)\n    POST /api/v1/cache/rebuild\n    Headers:\n        Content-Type: application/json\n        Authorization: Bearer <YOUR_AUTH_TOKEN>\n    Body:\n        {\n            \"module\": \"container_snapshots\",\n            \"entity_id\": \"CMAU0000020\",\n            \"force_refresh\": true\n        }\n    ```\n    *   **Verification:**\n        *   Monitor the API response for success (e.g., HTTP 200 OK).\n        *   Check `cache_service.log` or similar logs for confirmation that the cache rebuild for `CMAU0000020` was initiated and completed successfully.\n        *   If possible, verify data consistency in a downstream system or API endpoint that consumes this data (e.g., query the yard management system's API for `CMAU0000020` to ensure it shows the correct, single location/status).\n\n---\n\n**Ready to Close Checklist:**\n\n*   [ ] Confirmed duplicate snapshots were identified in the database.\n*   [ ] Successfully retained only the most recent, valid snapshot for `CMAU0000020`.\n*   [ ] Verified that only one record for `CMAU0000020` exists in the `container_snapshots` table.\n*   [ ] Triggered and confirmed successful cache rebuild/refresh for container data.\n*   [ ] Verified (if possible) that downstream systems reflect the corrected container data.\n*   [ ] Incident log updated with resolution steps and verification outcomes.",
      "module": "CNTR",
      "expectedOutcome": null,
      "results": {
        "procedureCompliance": {
          "score": 70,
          "issues": [
            "Missing required step: validate container status",
            "Missing required step: check location data",
            "Missing required step: verify ownership"
          ],
          "category": "procedure_compliance"
        },
        "accuracyCheck": {
          "score": 85,
          "issues": [
            "Missing container status check"
          ],
          "category": "accuracy"
        },
        "safetyValidation": {
          "score": 75,
          "issues": [
            "Missing safety consideration: proper documentation"
          ],
          "category": "safety"
        },
        "completenessCheck": {
          "score": 100,
          "issues": [],
          "category": "completeness"
        },
        "clarityScore": {
          "score": 100,
          "issues": [],
          "category": "clarity"
        }
      },
      "overallScore": 86,
      "passed": true
    },
    "CNTR_1336769417_1760803516627": {
      "testId": "CNTR_1336769417_1760803516627",
      "timestamp": "2025-10-18T16:05:16.628Z",
      "query": "playbook for Duplicate container snapshot detected: Data quality monitor detected that container CMAU0000020 was inserted twice within one second, creating inconsistent yard inventory views.",
      "aiResponse": "Playbook: ALR-861600 — Duplicate container snapshot detected (CMAU0000020)\nReference: KB-2210 (CNTR-024) — \"Duplicate Container information received\"\n\nPurpose: Detect and remediate duplicate container snapshot rows for cntr_no=CMAU0000020, preserve latest operational snapshot, archive older duplicates, and force downstream consumers to pick up corrected state. No escalation required.\n\nKey safety notes:\n- Take backups and operate in a transaction. Do not delete without archiving.\n- Coordinate a short maintenance window or quiesce upstream writers if possible to prevent further duplicate writes while remediation executes.\n- Preserve logs and export duplicates for audit.\n\nStep-by-step actions (numbered; each step includes verification)\n\n1) Action 1 — Evidence capture & initial assessment\n   - Label: Capture evidence, note timestamps and counts.\n   - Actions:\n     a) Export the relevant log lines and DB rows for CMAU0000020 to an evidence file.\n     b) Record the exact counts of duplicate rows and their timestamps.\n   - Commands (examples):\n```sql\n-- type: sql\n-- Export current rows for CMAU0000020 to an audit table/file (run on a copy or read-only replica if available)\nSELECT id, cntr_no, snapshot_ts, payload, created_at\nFROM container\nWHERE cntr_no = 'CMAU0000020'\nORDER BY snapshot_ts DESC;\n```\n   - Verification:\n     - Confirm you have N>1 rows returned (evidence of duplicates).\n     - Save output to evidence location (e.g., /var/ops/evidence/ALR-861600-cma u0000020.csv).\n\n   - KB: See KB-2210 for expected duplicate patterns and fields to capture.\n\n2) Action 2 — Coordinate/Quiesce writers (Operational safety)\n   - Label: Prevent concurrent writes\n   - Actions:\n     - Notify upstream systems owners (ingest API / container producer) and place a short hold or enable maintenance mode for the container snapshot feed, if possible (expected hold: 2–10 minutes).\n   - Verification:\n     - Confirm no new DuplicateSnapshotAttempt warnings are generated while working by tailing logs:\n       - Monitor container_service.log for DuplicateSnapshotAttempt messages:\n         - Example: tail -F /var/log/container_service.log | grep --line-buffered DuplicateSnapshotAttempt\n     - KB: KB-2210 recommends minimizing concurrent writes during remediation.\n\n3) Action 3 — Full backup / snapshot of relevant tables\n   - Label: Backup\n   - Actions:\n     - Take a consistent backup or snapshot of the database (or at minimum the container table and related indexes).\n   - Verification:\n     - Confirm backup/snapshot exists and is restorable (record backup id and location).\n\n4) Action 4 — Detect duplicates definitively (read-only confirmation)\n   - Label: Detect duplicates\n   - Actions:\n     - Run query to list duplicates by cntr_no with exact timestamps and row ids.\n```sql\n-- type: sql\n-- Find duplicates for this container and show ordering\nSELECT id, cntr_no, snapshot_ts, payload, created_at\nFROM container\nWHERE cntr_no = 'CMAU0000020'\nORDER BY snapshot_ts DESC, created_at DESC;\n```\n   - Verification:\n     - Confirm there are multiple rows, and identify which row has the most recent snapshot_ts / created_at (this will be the row to retain).\n     - Note IDs of older rows to archive (e.g., id IN (101,102)).\n\n5) Action 5 — Archive older duplicate rows (retain most recent)\n   - Label: Archive old snapshots (preserve audit)\n   - High-level: Insert older duplicate rows into container_archive (or container_audit) and then delete them from live table inside a transaction.\n   - Actions:\n     a) Create archive table if not present (preserve original schema + metadata).\n     b) Insert older rows into archive with an archive_ts and reason.\n     c) Delete older rows from live table.\n```sql\n-- type: sql\n-- (1) Ensure archive table exists (run once)\nCREATE TABLE IF NOT EXISTS container_archive AS TABLE container WITH NO DATA;\n\n-- (optional) Add archive metadata columns if not present\nALTER TABLE container_archive\n  ADD COLUMN IF NOT EXISTS archive_ts timestamptz,\n  ADD COLUMN IF NOT EXISTS archive_reason text;\n\n-- type: sql\n-- (2) In a transaction: archive older rows and remove from live\nBEGIN;\n\n-- Identify the latest row id to keep\nWITH ranked AS (\n  SELECT id, cntr_no, snapshot_ts, created_at,\n         ROW_NUMBER() OVER (PARTITION BY cntr_no ORDER BY snapshot_ts DESC, created_at DESC) AS rn\n  FROM container\n  WHERE cntr_no = 'CMAU0000020'\n)\n-- Insert rows where rn > 1 into archive\nINSERT INTO container_archive (id, cntr_no, snapshot_ts, payload, created_at, archive_ts, archive_reason)\nSELECT id, cntr_no, snapshot_ts, payload, created_at, NOW(), 'Duplicate snapshot archive (ALR-861600)'\nFROM ranked\nWHERE rn > 1;\n\n-- Delete the archived rows from live table\nDELETE FROM container\nWHERE id IN (SELECT id FROM ranked WHERE rn > 1);\n\nCOMMIT;\n```\n   - Verification:\n     - Query the live table to ensure only one row remains:\n```sql\n-- type: sql\nSELECT COUNT(*) AS live_count, MIN(snapshot_ts) AS min_ts, MAX(snapshot_ts) AS max_ts\nFROM container\nWHERE cntr_no = 'CMAU0000020';\n```\n     - Expected: live_count = 1, and snapshot_ts = the most recent value identified previously.\n     - Confirm archive rows exist with an archive_reason and archive_ts:\n```sql\n-- type: sql\nSELECT COUNT(*) AS archived_count FROM container_archive WHERE cntr_no='CMAU0000020';\n```\n\n6) Action 6 — Sanity-check payload & integrity\n   - Label: Validate retained snapshot\n   - Actions:\n     - Examine payload and schema fields for the retained snapshot to ensure it is complete and consistent.\n     - If payload contains sequence or version fields, confirm it is the highest/latest version.\n   - Verification:\n     - Compare retained snapshot payload to recent API response or other authoritative source (if available).\n\n7) Action 7 — Rebuild cache consumers / downstream sync (KB-2210)\n   - Label: Rebuild cache / force downstream sync\n   - Actions:\n     - Trigger downstream sync or cache invalidation so API consumers pick up corrected state (per KB-2210).\n     - Example API calls: invalidate cache endpoint or publish change event to message bus.\n```api\n-- type: api\n# Example: call internal cache-invalidate endpoint for this container\nPOST /internal/cache/invalidate\nHost: internal-api.example.local\nContent-Type: application/json\n\n{\n  \"entity\": \"container\",\n  \"cntr_no\": \"CMAU0000020\",\n  \"reason\": \"Duplicate snapshot remediation ALR-861600\"\n}\n```\n   - If using message bus, publish a change event:\n```api\n-- type: api\n# Example: POST to internal event producer\nPOST /internal/events/publish\nHost: events-producer.internal\nContent-Type: application/json\n\n{\n  \"topic\": \"container.upsert\",\n  \"payload\": {\n    \"cntr_no\": \"CMAU0000020\",\n    \"action\": \"sync\",\n    \"source\": \"ALR-861600-remediation\"\n  }\n}\n```\n   - Verification:\n     - Check cache/invalidator response code (200 OK) and returned status.\n     - Confirm consumer APIs now return the retained snapshot for CMAU0000020:\n```sql\n-- type: sql\nSELECT id, cntr_no, snapshot_ts, payload\nFROM container\nWHERE cntr_no = 'CMAU0000020';\n```\n     - Verify API consumer endpoint returns same snapshot (example curl):\n```api\n-- type: api\nGET /api/containers/CMAU0000020\nHost: api.example.com\n```\n     - Expected: API returns the retained snapshot timestamp/payload.\n\n8) Action 8 — Log verification & monitoring\n   - Label: Confirm no recurrence\n   - Actions:\n     - Monitor container_service.log for occurrences of DuplicateSnapshotAttempt for at least the agreed observation window (recommend 24 hours).\n     - Check audit logs for any other duplicate insert attempts.\n   - Example log checks:\n     - Grep for the warning:\n       - grep \"DuplicateSnapshotAttempt .* cntr_no=CMAU0000020\" /var/log/container_service.log\n     - Tail and monitor for 24 hours; consider alert suppression only while monitoring remediation.\n   - Verification:\n     - No new DuplicateSnapshotAttempt entries for CMAU0000020 after remediation (for the observation window).\n     - No other containers show similar duplicate pattern (run a broader query if desired).\n\n9) Action 9 — Document remediation & root-cause notes\n   - Label: Documentation & follow-up\n   - Actions:\n     - Record remediation steps taken, timestamps, backup id, archive table entries, and evidence files.\n     - Add entry to incident tracker: ALR-861600, include KB-2210 reference and attach exports.\n     - Recommend follow-up: investigate upstream producer timing resolution to avoid near-simultaneous inserts (see KB-2210 for guidance).\n   - Verification:\n     - Confirm incident record contains links to evidence, SQL executed, and archive entries.\n\n10) Action 10 — Ready to close checklist\n   - Label: Ready to close\n   - Checklist items (all must be ticked before closing):\n     1. [ ] Evidence exported and stored (logs and DB rows) — file path recorded.\n     2. [ ] Database backup/snapshot created before changes — backup ID recorded.\n     3. [ ] Older duplicate rows archived into container_archive with archive_reason and archive_ts — verify archive count.\n     4. [ ] Live container table contains exactly one snapshot row for CMAU0000020 — verified by query.\n     5. [ ] Downstream caches invalidated / consumers resynced — API response verified.\n     6. [ ] No DuplicateSnapshotAttempt warnings for CMAU0000020 observed during observation window (recommended 24h) — monitoring log output captured.\n     7. [ ] Incident documented with KB-2210 referenced and remediation steps attached.\n     8. [ ] Stakeholders (ingest owner / API owner) notified and confirmation received (if required).\n   - Final verification before close:\n     - Show the final DB check output (example):\n```sql\n-- type: sql\nSELECT COUNT(*) AS live_count, MAX(snapshot_ts) AS current_snapshot_ts\nFROM container\nWHERE cntr_no = 'CMAU0000020';\n```\n     - Expected: live_count = 1.\n\nNotes / Additional guidance\n- Per KB-2210: prefer archiving over hard delete to preserve audit trail and to match retention policies.\n- If duplicates are frequent/systemic, open a follow-up task to throttle or deduplicate upstream producers using idempotency keys or sequence/version checks.\n- Keep the archived rows for the duration mandated by policy; mark archive_reason clearly as \"ALR-861600 duplicate snapshot archive\".\n\nExample quick verification commands summary (run after remediation)\n- Confirm live single row:\n```sql\n-- type: sql\nSELECT id, cntr_no, snapshot_ts, created_at FROM container WHERE cntr_no='CMAU0000020';\n```\n- Confirm archived rows:\n```sql\n-- type: sql\nSELECT id, archive_ts, archive_reason FROM container_archive WHERE cntr_no='CMAU0000020';\n```\n- Confirm no recent log warnings:\n  - tail -n 200 /var/log/container_service.log | grep DuplicateSnapshotAttempt | grep CMAU0000020\n\nKB Reference: KB-2210 (CNTR-024) — follow the duplicate snapshot detection and archive-first remediation steps described therein.\n\nIf you want, I can generate the exact SQL used (with ids replaced by the actual ids returned by the detect query) and an ops-ready runbook snippet to paste into the maintenance window ticket.",
      "module": "CNTR",
      "expectedOutcome": null,
      "results": {
        "procedureCompliance": {
          "score": 70,
          "issues": [
            "Missing required step: validate container status",
            "Missing required step: check location data",
            "Missing required step: verify ownership"
          ],
          "category": "procedure_compliance"
        },
        "accuracyCheck": {
          "score": 85,
          "issues": [
            "Missing container status check"
          ],
          "category": "accuracy"
        },
        "safetyValidation": {
          "score": 100,
          "issues": [],
          "category": "safety"
        },
        "completenessCheck": {
          "score": 100,
          "issues": [],
          "category": "completeness"
        },
        "clarityScore": {
          "score": 100,
          "issues": [],
          "category": "clarity"
        }
      },
      "overallScore": 91,
      "passed": true
    },
    "CNTR_1336769417_1760803543620": {
      "testId": "CNTR_1336769417_1760803543620",
      "timestamp": "2025-10-18T16:05:43.620Z",
      "query": "playbook for Duplicate container snapshot detected: Data quality monitor detected that container CMAU0000020 was inserted twice within one second, creating inconsistent yard inventory views.",
      "aiResponse": "Incident: ALR-861600 — Duplicate container snapshot detected for CMAU0000020 (Medium)\nRole: Yard Duty Officer\nReference: [KB-2210] CNTR-024 Duplicate Container information received\n\nSummary:\nData monitor reported two snapshots for container CMAU0000020 inserted within one second producing inconsistent yard inventory. No escalation required. Follow the steps below to detect, contain, correct, and verify. Each step includes verification checks. Preserve operational safety — perform DB writes during a low-activity window and take a DB backup before making changes.\n\nAction steps (numbered with labels)\n\n1) PREPARE — Take backup & gather evidence\n   - Label: PREP-01\n   - Purpose: Preserve state before any modification; collect evidence for audit and rollback.\n   - Actions:\n     a) Take a logical backup (or DB snapshot) of the container table and related indexes.\n     b) Export the two duplicate rows and container_service.log lines that show DuplicateSnapshotAttempt.\n   - Commands (SQL):\n     (SQL)\n     ```\n     -- create a quick logical backup of the relevant rows\n     SELECT * INTO container_backup_ALR861600\n     FROM container\n     WHERE cntr_no = 'CMAU0000020';\n\n     -- export any related rows that may reference this container (optional)\n     SELECT * INTO container_links_backup_ALR861600\n     FROM container_links\n     WHERE cntr_no = 'CMAU0000020';\n     ```\n   - Verification:\n     - Confirm container_backup_ALR861600 contains the duplicate rows.\n     - Save a copy of container_service.log lines showing \"DuplicateSnapshotAttempt cntr_no=CMAU0000020\" to the incident record.\n\n2) DETECT — Confirm duplicates exist and identify latest snapshot\n   - Label: DETECT-01\n   - Purpose: Verify duplicates and determine which row is the most recent operational state per KB guidance.\n   - Actions:\n     a) Query the DB for all rows with cntr_no CMAU0000020 and list ordering by timestamp/version.\n   - Commands (SQL):\n     (SQL)\n     ```\n     -- list all container snapshots for inspect\n     SELECT id, cntr_no, snapshot_ts, version, created_at, updated_at, payload\n     FROM container\n     WHERE cntr_no = 'CMAU0000020'\n     ORDER BY snapshot_ts DESC, updated_at DESC;\n     \n     -- detect potential duplicates within 1s across the full table (optional)\n     SELECT cntr_no, snapshot_ts, COUNT(*) AS dup_count\n     FROM container\n     WHERE cntr_no = 'CMAU0000020'\n     GROUP BY cntr_no, snapshot_ts\n     HAVING COUNT(*) > 1;\n     ```\n   - Verification:\n     - Confirm query returns two (or >1) rows with same or near-identical snapshot_ts.\n     - Note the id (primary key) of the row that should be kept (typically the top row = most recent by snapshot_ts/updated_at/version). Record that id in the incident notes.\n\n   - KB reference: [KB-2210] step 1 Detect duplicate snapshots.\n\n3) SAFE LOCK — Obtain transactional lock & re-check (prevent concurrent writes)\n   - Label: LOCK-01\n   - Purpose: Prevent concurrent snapshot writes during correction.\n   - Actions:\n     a) Start a DB transaction and lock the target rows (SELECT ... FOR UPDATE).\n   - Commands (SQL):\n     (SQL)\n     ```\n     BEGIN TRANSACTION;\n\n     -- lock all rows for this container to prevent concurrent writes\n     SELECT id, cntr_no, snapshot_ts, version\n     FROM container\n     WHERE cntr_no = 'CMAU0000020'\n     FOR UPDATE;\n     ```\n   - Verification:\n     - Transaction started and SELECT FOR UPDATE returns expected rows. Do not commit/rollback yet.\n\n4) ARCHIVE OLD SNAPSHOTS — Retain most recent snapshot; archive older duplicates\n   - Label: ARCHIVE-01\n   - Purpose: Preserve older snapshots in an archive table and keep only the most recent operational row in the live table as per KB.\n   - Actions:\n     a) Identify latest row id (from step 2).\n     b) Insert older rows into container_archive, then delete them from container.\n   - Commands (SQL):\n     (SQL)\n     ```\n     -- assume latest_id obtained previously, e.g., 12345\n     -- ARCHIVE older rows\n     INSERT INTO container_archive\n     SELECT *, current_timestamp AS archived_at\n     FROM container\n     WHERE cntr_no = 'CMAU0000020'\n       AND id <> <latest_id>;\n\n     -- confirm rows inserted into archive\n     SELECT COUNT(*) FROM container_archive WHERE cntr_no = 'CMAU0000020' AND archived_at IS NOT NULL;\n\n     -- delete the older rows from live table\n     DELETE FROM container\n     WHERE cntr_no = 'CMAU0000020'\n       AND id <> <latest_id>;\n     ```\n   - Note: Replace <latest_id> with actual id from DETECT-01.\n   - Verification:\n     - After INSERT check container_archive contains the older row(s).\n     - After DELETE, confirm only one row remains in container for CMAU0000020:\n       (SQL)\n       ```\n       SELECT COUNT(*) as live_count FROM container WHERE cntr_no = 'CMAU0000020';\n       ```\n       Expect live_count = 1.\n     - Check that payload/version on the retained row matches the most recent snapshot from step 2.\n\n5) COMMIT & RELEASE LOCK\n   - Label: COMMIT-01\n   - Purpose: Finalize change and release DB locks.\n   - Actions:\n     a) Commit the transaction if all archive/delete verifications pass; otherwise ROLLBACK and escalate.\n   - Commands (SQL):\n     (SQL)\n     ```\n     COMMIT;\n     ```\n   - Verification:\n     - Confirm transaction committed and no outstanding locks for cntr_no CMAU0000020.\n     - Optionally run the DETECT query again outside any transaction:\n       (SQL)\n       ```\n       SELECT id, cntr_no, snapshot_ts, version FROM container WHERE cntr_no = 'CMAU0000020';\n       ```\n\n6) TRIGGER DOWNSTREAM SYNC / CACHE REBUILD\n   - Label: SYNC-01\n   - Purpose: Ensure downstream cache/API consumers receive corrected inventory (KB-2210 step 3).\n   - Actions:\n     a) Call the internal cache/sync API for this container or trigger a rebuild for the container caches used by yard systems.\n   - Commands (API)\n     ```\n     POST /internal/sync/container\n     Authorization: Bearer <service-token>\n     Content-Type: application/json\n\n     {\n       \"cntr_no\": \"CMAU0000020\",\n       \"reason\": \"Duplicate snapshot resolved - ALR-861600\"\n     }\n     ```\n     Example using a specific endpoint:\n     ```\n     POST /v1/cache/rebuild/container?container_no=CMAU0000020\n     Authorization: Bearer <service-token>\n     ```\n   - Verification:\n     - API returns 200/accepted and a job id. Record the job id.\n     - Poll job status endpoint if present until status=success.\n     - Confirm downstream API returns consistent single snapshot for CMAU0000020:\n       (API)\n       ```\n       GET /v1/containers/CMAU0000020\n       Authorization: Bearer <service-token>\n       ```\n       Expect response with a single current snapshot matching the retained row.\n\n   - KB reference: [KB-2210] step 3 Rebuild cache consumers.\n\n7) LOGS & MONITOR — Confirm warning no longer repeats\n   - Label: MONITOR-01\n   - Purpose: Ensure duplicate snapshot attempts have ceased and system stabilized.\n   - Actions:\n     a) Search logs for recent DuplicateSnapshotAttempt entries after remediation.\n   - Commands (SQL) and Shell suggestion:\n     (Shell)\n     ```\n     # grep recent log entries (example)\n     grep \"DuplicateSnapshotAttempt cntr_no=CMAU0000020\" /var/log/container_service.log | tail -n 50\n     ```\n   - Verification:\n     - No new DuplicateSnapshotAttempt lines for CMAU0000020 after the timestamp of commit.\n     - If new attempts appear, escalate to development team and provide archived rows and timestamps.\n\n8) DOCUMENTATION & INCIDENT NOTES\n   - Label: DOC-01\n   - Purpose: Record actions, evidence, and why older snapshots were archived.\n   - Actions:\n     a) Add the following into the incident record:\n        - Pre-change backup name (container_backup_ALR861600)\n        - IDs of archived rows and archive table references\n        - Latest retained id\n        - API job id for cache rebuild\n        - Log excerpts showing initial warning and final verification\n        - Reference KB article: [KB-2210] CNTR-024\n   - Verification:\n     - Incident record contains all items and attachments; timestamps and operator name included.\n\nReady to close checklist\n  - [ ] Pre-change backup created and stored (container_backup_ALR861600).\n  - [ ] Duplicate rows detected and latest snapshot identified (IDs recorded).\n  - [ ] Older snapshot(s) archived to container_archive and verified.\n  - [ ] Live container table contains only the intended latest snapshot (COUNT = 1).\n  - [ ] DB transaction committed and locks released.\n  - [ ] Downstream cache/APIs rebuilt; job id recorded and completed successfully.\n  - [ ] Logs rechecked: no new DuplicateSnapshotAttempt for CMAU0000020 post-fix.\n  - [ ] Incident record updated with evidence and KB reference [KB-2210] CNTR-024.\n  - [ ] Stakeholders informed (if required) and no escalation required.\n\nNotes & Safety:\n  - Always perform the DB changes inside a transaction and during low-activity windows where possible.\n  - If the duplicate snapshots represent different payload states and it's unclear which to keep, follow KB-2210 guidance: retain the most recent by snapshot_ts/version. If business rules differ, consult application owners before deletion.\n  - If this pattern repeats for other containers, open a ticket for engineering to fix the upstream snapshot deduplication logic.\n\nIf you want, I can produce the exact SQL with the real latest_id (replace placeholder) after you paste the SELECT results from step 2, or run the detection queries for all containers to see if others are affected.",
      "module": "CNTR",
      "expectedOutcome": null,
      "results": {
        "procedureCompliance": {
          "score": 70,
          "issues": [
            "Missing required step: validate container status",
            "Missing required step: check location data",
            "Missing required step: verify ownership"
          ],
          "category": "procedure_compliance"
        },
        "accuracyCheck": {
          "score": 85,
          "issues": [
            "Missing container status check"
          ],
          "category": "accuracy"
        },
        "safetyValidation": {
          "score": 100,
          "issues": [],
          "category": "safety"
        },
        "completenessCheck": {
          "score": 100,
          "issues": [],
          "category": "completeness"
        },
        "clarityScore": {
          "score": 100,
          "issues": [],
          "category": "clarity"
        }
      },
      "overallScore": 91,
      "passed": true
    },
    "CNTR_1740787713_1760803750605": {
      "testId": "CNTR_1740787713_1760803750605",
      "timestamp": "2025-10-18T16:09:10.605Z",
      "query": "escalation for Duplicate container snapshot detected: Data quality monitor detected that container CMAU0000020 was inserted twice within one second, creating inconsistent yard inventory views.",
      "aiResponse": "Action Plan (Yard Duty Officer) — ALR-861600: Duplicate container snapshot for CMAU0000020\n\n1) Detect duplicate snapshots (Label: Detect)\n- Purpose: Confirm duplicated snapshots exist before remediation (KB-2210).\n- Command (SQL):\n```sql\n-- Type: SQL\nSELECT id, cntr_no, snapshot_ts, created_at, archived\nFROM container\nWHERE cntr_no = 'CMAU0000020'\nORDER BY snapshot_ts DESC, created_at DESC;\n```\n- Verification: Confirm >1 row returned with identical or near-identical snapshot_ts (logs already show two rows). Record the latest id as keep_id.\n\n2) Isolate and preserve the latest snapshot (Label: PreserveLatest)\n- Purpose: Ensure operational state preserved, avoid data loss (KB-2210).\n- Steps:\n  a) Identify keep_id:\n```sql\n-- Type: SQL\nSELECT id\nFROM container\nWHERE cntr_no = 'CMAU0000020'\nORDER BY snapshot_ts DESC, created_at DESC\nLIMIT 1;\n```\n  b) Mark older rows archived (preferred over deletion):\n```sql\n-- Type: SQL\nBEGIN;\nUPDATE container\nSET archived = TRUE, archived_at = NOW(), archive_reason = 'Duplicate snapshot cleanup ALR-861600'\nWHERE cntr_no = 'CMAU0000020' AND id <> <keep_id>;\nCOMMIT;\n```\n- Verification: Re-run detection query to show only one non-archived row:\n```sql\n-- Type: SQL\nSELECT COUNT(*) AS active_rows\nFROM container\nWHERE cntr_no = 'CMAU0000020' AND archived = FALSE;\n```\nExpected active_rows = 1.\n\n3) Archive older duplicate rows into archive table (Label: Archive)\n- Purpose: Retain full audit trail and evidence (safety/compliance).\n- Command (SQL):\n```sql\n-- Type: SQL\nBEGIN;\nINSERT INTO container_archive (id, cntr_no, snapshot_ts, data, created_at, archived_at, archive_reason)\nSELECT id, cntr_no, snapshot_ts, data, created_at, NOW(), 'Duplicate snapshot cleanup ALR-861600'\nFROM container\nWHERE cntr_no = 'CMAU0000020' AND id <> <keep_id>;\n\n-- Optional: soft-delete or delete after archival policy\nDELETE FROM container\nWHERE cntr_no = 'CMAU0000020' AND id <> <keep_id>;\nCOMMIT;\n```\n- Verification: Confirm rows moved:\n```sql\n-- Type: SQL\nSELECT COUNT(*) FROM container_archive WHERE cntr_no = 'CMAU0000020';\n```\n\n4) Rebuild cache consumers / downstream sync (Label: RebuildConsumers)\n- Purpose: Ensure APIs and yard display services reflect corrected inventory (KB-2210).\n- API call (example):\n```http\n# Type: HTTP\nPOST /internal/cache/rebuild\nHost: api.portwarden.local\nAuthorization: Bearer <service-token>\nContent-Type: application/json\n\n{\n  \"resource\": \"container\",\n  \"identifier\": \"CMAU0000020\",\n  \"reason\": \"Duplicate snapshot cleanup ALR-861600\"\n}\n```\n- Verification:\n  - Confirm HTTP 200 with job id.\n  - Check consumer logs and API responses for CMAU0000020:\n```http\n# Type: HTTP\nGET /v1/containers/CMAU0000020\nHost: api.portwarden.local\nAuthorization: Bearer <service-token>\n```\nExpect single, correct snapshot returned.\n\n5) Validate logs and stop-gap monitoring (Label: ValidateMonitor)\n- Purpose: Ensure no ongoing duplicate attempts and that mitigation is effective.\n- Steps:\n  - Tail service logs for DuplicateSnapshotAttempt entries for CMAU0000020 over the next 2 hours:\n    - container_service.log\n  - Verify no repeated insert attempts in DB audit:\n```sql\n-- Type: SQL\nSELECT created_at, message\nFROM system_audit\nWHERE object_type = 'container' AND object_id = 'CMAU0000020'\nORDER BY created_at DESC\nLIMIT 20;\n```\n- Verification criteria:\n  - No new DuplicateSnapshotAttempt WARN entries after remediation.\n  - No new duplicate rows created within 1s window.\n\n6) Follow-up actions and KB update (Label: FollowUp)\n- Purpose: Prevent recurrence and document resolution.\n- Actions:\n  - Raise a ticket to dev team to review producer service that emitted duplicate snapshots (include logs: container_service.log lines).\n  - Update incident record and reference KB-2210 (CNTR-024) with steps taken and timestamps.\n  - Consider adding a short-term alert: trigger when same cntr_no inserted >1 time within 5s.\n- Verification:\n  - Confirm ticket created with link and assigned owner.\n  - Confirm KB updated entry added with incident id ALR-861600.\n\nNotes: Evidence observed: container_service.log WARN DuplicateSnapshotAttempt; DB showed two rows with same timestamps. No escalation required per guidance. Preserve audit trail per policy.\n\nDraft escalation summary (for email) — keep <180 words:\n\nSubject: ALR-861600 — Duplicate container snapshot detected for CMAU0000020 (No escalation)\n\nSummary:\nOn [timestamp], the data quality monitor flagged ALR-861600: two container snapshots for CMAU0000020 were recorded within one second, creating inconsistent yard inventory views. Mitigation: we identified and retained the most recent snapshot, archived the older duplicate to container_archive, and triggered a downstream cache rebuild so API consumers and yard displays reflect the corrected state. Risk: transient mis-reads of yard inventory until cache rebuild completes; no operational safety impact identified. Ask: no immediate escalation required — request confirmation from the container producer team to investigate the source of rapid duplicate sends. Timeline: detection and remediation completed within the hour; follow-up ticket opened for root-cause analysis. Reference: KB-2210 (Duplicate Container information received). Evidence attached: container_service.log extract and DB audit rows.\n\nIf you want, I will run the SQL/API steps now and provide verification outputs.",
      "module": "CNTR",
      "expectedOutcome": null,
      "results": {
        "procedureCompliance": {
          "score": 70,
          "issues": [
            "Missing required step: validate container status",
            "Missing required step: check location data",
            "Missing required step: verify ownership"
          ],
          "category": "procedure_compliance"
        },
        "accuracyCheck": {
          "score": 85,
          "issues": [
            "Missing container status check"
          ],
          "category": "accuracy"
        },
        "safetyValidation": {
          "score": 75,
          "issues": [
            "Missing safety consideration: proper documentation"
          ],
          "category": "safety"
        },
        "completenessCheck": {
          "score": 100,
          "issues": [],
          "category": "completeness"
        },
        "clarityScore": {
          "score": 100,
          "issues": [],
          "category": "clarity"
        }
      },
      "overallScore": 86,
      "passed": true
    },
    "CNTR_1336769417_1760806252701": {
      "testId": "CNTR_1336769417_1760806252701",
      "timestamp": "2025-10-18T16:50:52.701Z",
      "query": "playbook for Duplicate container snapshot detected: Data quality monitor detected that container CMAU0000020 was inserted twice within one second, creating inconsistent yard inventory views.",
      "aiResponse": "Playbook: ALR-861600 — Duplicate container snapshot detected for CMAU0000020\nReference: [KB-2210] (CNTR-024) Duplicate Container information received\n\nImportant safety notes (do before modifications)\n- Take a full logical backup of the container table and application state before any DML. Work in a transaction or maintenance window if available.\n- Test the deletion/archive steps on staging with an identical schema first.\n- No escalation required per guidance; proceed per KB-2210.\n\nAction Steps (numbered, labeled) with verification\n\n1) Confirm duplicate snapshots exist (Detect)\n- Purpose: Verify there are multiple rows for CMAU0000020 and capture metadata (ids, timestamps, versions).\n- Command (read-only):\n```sql\n-- [type: SQL]\nSELECT id, cntr_no, snapshot_ts, version, source, created_by\nFROM container\nWHERE cntr_no = 'CMAU0000020'\nORDER BY snapshot_ts DESC, id DESC;\n```\n- Verification:\n  - Confirm query returns >1 row.\n  - Record the id of the newest row (keep_id) and older ids (archive_ids).\n  - Save the query output to incident evidence (container_duplicates_<timestamp>.csv).\n\n2) Backup/Archive older duplicates (Retain most recent snapshot only, per KB-2210)\n- Purpose: Preserve older rows before removal so you can restore or audit.\n- Create an archive table if not present and copy older rows into it:\n```sql\n-- [type: SQL]\n-- create archive table (one-time)\nCREATE TABLE IF NOT EXISTS container_archive AS TABLE container WITH NO DATA;\n\n-- archive older rows (archive everything except the newest snapshot)\nWITH latest AS (\n  SELECT id FROM container\n  WHERE cntr_no = 'CMAU0000020'\n  ORDER BY snapshot_ts DESC, id DESC\n  LIMIT 1\n)\nINSERT INTO container_archive\nSELECT * FROM container\nWHERE cntr_no = 'CMAU0000020' AND id NOT IN (SELECT id FROM latest);\n```\n- Verification:\n  - Run:\n```sql\n-- [type: SQL]\nSELECT COUNT(*) AS archived_count FROM container_archive WHERE cntr_no = 'CMAU0000020';\n```\n  - Confirm archived_count equals (original duplicate count - 1).\n  - Ensure the archive table copy is stored in secure evidence storage and note file name.\n\n3) Remove older duplicate rows (Preserve latest operational state)\n- Purpose: Ensure only the latest snapshot remains in the operational container table.\n- Safe delete pattern (identify keep_id first):\n```sql\n-- [type: SQL]\n-- Identify keep_id\nSELECT id INTO TEMPORARY keep_row FROM container\nWHERE cntr_no = 'CMAU0000020'\nORDER BY snapshot_ts DESC, id DESC\nLIMIT 1;\n\n-- Delete others\nDELETE FROM container\nWHERE cntr_no = 'CMAU0000020' AND id NOT IN (SELECT id FROM keep_row);\n```\n(If your DB does not support SELECT INTO TEMPORARY as shown, first run the SELECT to capture keep_id externally and then run the DELETE with that id.)\n- Verification:\n  - Re-run:\n```sql\n-- [type: SQL]\nSELECT id, cntr_no, snapshot_ts, version FROM container WHERE cntr_no = 'CMAU0000020';\n```\n  - Confirm exactly 1 row remains and it matches the most recent snapshot recorded earlier.\n  - Record the result and store in incident evidence.\n\n4) Update audit/tracking records\n- Purpose: Leave a trace of the corrective action for audit and future diagnosis (per KB-2210).\n- Insert incident audit row:\n```sql\n-- [type: SQL]\nINSERT INTO container_audit (cntr_no, action, performed_by, performed_at, note)\nVALUES ('CMAU0000020', 'ARCHIVE_AND_DEDUPE', current_user, now(),\n 'Archived older duplicate snapshots; retained id=<keep_id>; ref ALR-861600, KB-2210');\n```\n- Verification:\n  - Confirm the audit row exists:\n```sql\n-- [type: SQL]\nSELECT * FROM container_audit WHERE cntr_no='CMAU0000020' ORDER BY performed_at DESC LIMIT 5;\n```\n\n5) Trigger downstream sync / rebuild cache consumers (per KB-2210)\n- Purpose: Ensure API consumers and caches receive the corrected single snapshot.\n- Example API call to trigger a resync for the container (adjust endpoint/auth to your environment):\n```http\n# [type: API]\ncurl -X POST \"https://internal-api.example.com/internal/containers/resync\" \\\n  -H \"Authorization: Bearer $ADMIN_TOKEN\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"cntr_no\":\"CMAU0000020\",\"reason\":\"Duplicate snapshot cleanup ALR-861600\",\"force\":true}'\n```\n- If you use a message bus (Kafka), publish an event:\n```http\n# [type: API]\n# Example: publish to internal topic (pseudo)\nPOST /events/topic/container-updates\n{\n  \"cntr_no\": \"CMAU0000020\",\n  \"event\": \"rebuild_snapshot\",\n  \"source\": \"ALR-861600\",\n  \"timestamp\": \"2025-10-18T...Z\"\n}\n```\n- Verification:\n  - Confirm API returns success (200/202) and response body indicates queued/resynced.\n  - Check consumer logs for successful processing:\n    - container_service.log: look for a sync/resync completion entry with cntr_no=CMAU0000020.\n```bash\n# verify in logs\ngrep \"CMAU0000020\" /var/log/container_service.log | grep -i resync\ngrep \"DuplicateSnapshotAttempt\" /var/log/container_service.log\n```\n\n6) Monitor post-fix stability and absence of repeated duplicate attempts\n- Purpose: Ensure duplicates do not reoccur and that system is stable.\n- Short-term monitoring (first 60 minutes):\n  - Run the duplicate detection query periodically (every 5–15 minutes) for 1 hour:\n```sql\n-- [type: SQL]\nSELECT COUNT(*) FROM container WHERE cntr_no = 'CMAU0000020';\n```\n  - Monitor logs for new DuplicateSnapshotAttempt warnings:\n```bash\n# [type: API/CLI]\ntail -f /var/log/container_service.log | grep --line-buffered \"DuplicateSnapshotAttempt\\|CMAU0000020\"\n```\n- Verification:\n  - No new DuplicateSnapshotAttempt entries for CMAU0000020 after the fix.\n  - Consumers (APIs, yard inventory views) reflect the corrected state — perform a representative API GET call:\n```http\n# [type: API]\ncurl -H \"Authorization: Bearer $USER_TOKEN\" \\\n  \"https://api.example.com/v1/containers/CMAU0000020\"\n```\n  - Confirm returned payload matches the retained snapshot.\n\n7) Document evidence and close incident\n- Purpose: Package evidence for post-incident review and closure.\n- Evidence to attach:\n  - Original detection output (first query) and timestamps.\n  - container_service.log excerpts showing DuplicateSnapshotAttempt and subsequent resync logs.\n  - container_archive records dump for CMAU0000020.\n  - SQL audit row id and content.\n- Include KB reference in notes: [KB-2210] CNTR-024.\n\nReady to close checklist\n- [ ] Full backup of container table performed and stored (path: <location>).\n- [ ] Older duplicate rows archived to container_archive (archive count verified).\n- [ ] Only latest snapshot for CMAU0000020 exists in production container table.\n- [ ] container_audit updated with action record.\n- [ ] Downstream cache/consumers triggered and processed the resync.\n- [ ] No new DuplicateSnapshotAttempt warnings for CMAU0000020 in the monitoring window (60 minutes).\n- [ ] API/yard inventory views show corrected data for CMAU0000020.\n- [ ] All evidence files (SQL exports, logs, API responses) attached to incident record.\n- [ ] KB reference added to incident: [KB-2210] (CNTR-024)\n- [ ] Stakeholders notified (Yard Ops, Data QA) — include names/timestamps.\n\nNotes and follow-up\n- If duplicates reappear, capture the full inbound message stream and source (which service produced both snapshots) and open follow-up incident referencing KB-2210; escalate per local on-call policy.\n- KB link: [KB-2210] contains the recommended retention and archive approach and downstream sync steps used above.\n\nIf you want, I can generate the specific SQL DELETE statement for your DB flavor (Postgres/MySQL/Oracle) or construct the exact curl command with your environment variables/endpoint.",
      "module": "CNTR",
      "expectedOutcome": null,
      "results": {
        "procedureCompliance": {
          "score": 70,
          "issues": [
            "Missing required step: validate container status",
            "Missing required step: check location data",
            "Missing required step: verify ownership"
          ],
          "category": "procedure_compliance"
        },
        "accuracyCheck": {
          "score": 85,
          "issues": [
            "Missing container status check"
          ],
          "category": "accuracy"
        },
        "safetyValidation": {
          "score": 75,
          "issues": [
            "Missing safety consideration: proper documentation"
          ],
          "category": "safety"
        },
        "completenessCheck": {
          "score": 100,
          "issues": [],
          "category": "completeness"
        },
        "clarityScore": {
          "score": 100,
          "issues": [],
          "category": "clarity"
        }
      },
      "overallScore": 86,
      "passed": true
    },
    "CNTR_1336769417_1760808238855": {
      "testId": "CNTR_1336769417_1760808238855",
      "timestamp": "2025-10-18T17:23:58.855Z",
      "query": "playbook for Duplicate container snapshot detected: Data quality monitor detected that container CMAU0000020 was inserted twice within one second, creating inconsistent yard inventory views.",
      "aiResponse": "Incident ALR-861600 — Playbook for duplicate container snapshot (CMAU0000020)\nReference: [KB-2210] CNTR: Duplicate Container information received (CNTR-024)\n\nNo escalation required. Follow the steps below in order. Each step contains the action, the exact SQL/API commands to run (in code blocks labeled with type), and verification checks.\n\n1) Action 1 — Confirm duplicate snapshots exist\n- Purpose: Verify there are multiple snapshot rows for CMAU0000020 and collect evidence before any change (per [KB-2210]).\n- Commands:\n```sql\n-- type: SQL\n-- List rows for the container with timestamps and primary key\nSELECT id, cntr_no, version, created_at, updated_at, payload\nFROM container\nWHERE cntr_no = 'CMAU0000020'\nORDER BY created_at ASC;\n```\n- Log check:\n```bash\n# type: API\n# Search service log for DuplicateSnapshotAttempt lines\ngrep \"DuplicateSnapshotAttempt\" container_service.log | grep \"CMAU0000020\" || true\n```\n- Verification:\n  - Confirm SQL returns >1 row for cntr_no=CMAU0000020.\n  - Confirm timestamps show two inserts within one second (or matching timestamps as indicated in evidence).\n  - Capture and attach the output and the log lines to the incident record.\n\n2) Action 2 — Identify the most recent snapshot to retain\n- Purpose: Determine the single canonical snapshot to keep (most recent operational state).\n- Commands:\n```sql\n-- type: SQL\n-- Identify latest snapshot (by created_at or version as appropriate)\nSELECT id, cntr_no, version, created_at, updated_at\nFROM container\nWHERE cntr_no = 'CMAU0000020'\nORDER BY created_at DESC\nLIMIT 1;\n```\n- Verification:\n  - Note the id (LATEST_ID) of the row to retain and record its created_at/version.\n  - Confirm it represents the expected operational state (inspect payload if needed).\n\n3) Action 3 — Archive older duplicate rows (transactional)\n- Purpose: Remove older duplicates from live table while preserving them in an audit/archive table (per [KB-2210] Retain most recent snapshot only).\n- Preconditions: Ensure there is an archive table (container_archive). If it does not exist, create it following DB schema standards and notify DB team.\n- Commands (transactional):\n```sql\n-- type: SQL\nBEGIN;\n\n-- 1) Copy older duplicates to archive for audit trail\nINSERT INTO container_archive (id, cntr_no, version, created_at, updated_at, payload, archived_at)\nSELECT id, cntr_no, version, created_at, updated_at, payload, now()\nFROM container\nWHERE cntr_no = 'CMAU0000020'\n  AND id <> <LATEST_ID>;  -- replace with id from Action 2\n\n-- 2) Delete older duplicate rows from live table\nDELETE FROM container\nWHERE cntr_no = 'CMAU0000020'\n  AND id <> <LATEST_ID>;\n\nCOMMIT;\n```\n- If your DB expects soft-delete instead of physical delete, use update to set is_active=false and archived_at.\n- Verification:\n  - Run:\n```sql\n-- type: SQL\nSELECT count(*) AS live_count FROM container WHERE cntr_no='CMAU0000020';\nSELECT count(*) AS archive_count FROM container_archive WHERE cntr_no='CMAU0000020';\nSELECT id, created_at, updated_at FROM container WHERE cntr_no='CMAU0000020';\n```\n  - Confirm live_count == 1 and the remaining id == LATEST_ID.\n  - Confirm archive_count increased by (original_count - 1) and archived rows have archived_at timestamp.\n  - Attach DB transaction logs, affected rows count, and SQL outputs to the incident.\n\n4) Action 4 — Rebuild cache / push corrected snapshot to downstream consumers\n- Purpose: Ensure APIs, caches, yard inventory services, and other consumers pick up the corrected snapshot (per [KB-2210] Rebuild cache consumers).\n- Commands — example API calls (replace host/auth as required):\n```http\n# type: API\n# Trigger container-level cache refresh for this container\ncurl -X POST \"https://internal-api.example.local/v1/cache/refresh\" \\\n  -H \"Authorization: Bearer $ADMIN_TOKEN\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"resource\":\"container\",\"cntr_no\":\"CMAU0000020\"}'\n```\n- If your system uses message broker:\n```http\n# type: API\n# Publish a sync event to the broker\ncurl -X POST \"https://broker.example.local/events\" \\\n  -H \"Authorization: Bearer $ADMIN_TOKEN\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"event\":\"container.updated\",\"cntr_no\":\"CMAU0000020\",\"source\":\"container-service\"}'\n```\n- Verification:\n  - Confirm API returns HTTP 200 and body indicates success.\n  - Check consumer logs (API/gateway/cache) for pick-up events within 30–120 seconds.\n  - Re-query public inventory endpoints / APIs to ensure they return the corrected single snapshot:\n```sql\n-- type: SQL\nSELECT cntr_no, count(*) FROM container_view WHERE cntr_no='CMAU0000020' GROUP BY cntr_no;\n```\n  - Confirm the count is 1 and timestamps match the retained snapshot.\n\n5) Action 5 — Monitor logs and data quality checks\n- Purpose: Confirm duplicate attempts have stopped and yard inventory views are consistent.\n- Commands:\n```bash\n# type: API\n# Tail logs for duplicate attempt warnings (monitor for 30-60 minutes)\ntail -n 5000 -F container_service.log | grep --line-buffered \"DuplicateSnapshotAttempt\\|CMAU0000020\"\n```\n```sql\n-- type: SQL\n-- Run data-quality monitor check for container-duplicates (ad-hoc)\nSELECT cntr_no, count(*) AS snapshots\nFROM container\nWHERE cntr_no = 'CMAU0000020'\nGROUP BY cntr_no\nHAVING count(*) > 1;\n```\n- Verification:\n  - Confirm no new DuplicateSnapshotAttempt warnings appear for CMAU0000020 in the monitoring window.\n  - Confirm automated data quality monitor returns no duplicates for CMAU0000020.\n  - Validate yard inventory view: run an end-to-end check to ensure inventory counts and container location match expected state.\n\n6) Action 6 — Document, attach evidence, and notify stakeholders\n- Purpose: Ensure traceability and closure.\n- Tasks:\n  - Attach: SQL outputs (Actions 1–3), DB transaction ID, container_service.log lines showing initial warning, archive table insert results, cache-refresh API response.\n  - Document steps taken, LATEST_ID retained, archive record IDs, timestamps, and that no escalation was required per guidance.\n  - Notify yard ops and API consumers that the duplication was removed and the cache was rebuilt.\n\nVerification:\n  - Confirm incident ticket has attachments listed above.\n  - Confirm stakeholders acknowledged receipt (email or ticket update).\n\nReady to close checklist\n- [ ] Duplicate snapshots verified (Action 1) and evidence attached.\n- [ ] Latest snapshot identified and older snapshots archived (Action 2–3); live table contains single row for CMAU0000020.\n- [ ] Cache/consumers refreshed and API consumers report consistent data (Action 4).\n- [ ] Monitoring window completed with no new DuplicateSnapshotAttempt warnings for CMAU0000020 (Action 5).\n- [ ] Ticket updated with commands run, SQL outputs, logs, and archive references; stakeholders notified (Action 6).\n- [ ] Reference to KB applied: [KB-2210] CNTR-024 included in ticket notes.\n\nAdditional notes and safeguards\n- If you cannot perform DB writes in production, escalate to DB Admin with the SQL above and request transactional archive + delete. Reference [KB-2210] when requesting assistance.\n- If archive table does not exist, create it per retention policy and notify compliance before purging.\n- If duplicates are frequent, open a follow-up action to trace source service producing duplicate snapshot attempts and apply application-side dedup logic (see KB-2210 guidance).\n- For audit: do not permanently delete archived rows unless retention policy permits—use container_archive to preserve history.\n\nKB references used\n- [KB-2210] CNTR: Duplicate Container information received (CNTR-024)\n\nIf you want, I can:\n- Generate the exact SQL with the LATEST_ID inserted once you paste the SELECT output from Action 2.\n- Produce an email template to notify yard ops and API consumers with the attached evidence.",
      "module": "CNTR",
      "expectedOutcome": null,
      "results": {
        "procedureCompliance": {
          "score": 70,
          "issues": [
            "Missing required step: validate container status",
            "Missing required step: check location data",
            "Missing required step: verify ownership"
          ],
          "category": "procedure_compliance"
        },
        "accuracyCheck": {
          "score": 85,
          "issues": [
            "Missing container status check"
          ],
          "category": "accuracy"
        },
        "safetyValidation": {
          "score": 75,
          "issues": [
            "Missing safety consideration: proper documentation"
          ],
          "category": "safety"
        },
        "completenessCheck": {
          "score": 100,
          "issues": [],
          "category": "completeness"
        },
        "clarityScore": {
          "score": 100,
          "issues": [],
          "category": "clarity"
        }
      },
      "overallScore": 86,
      "passed": true
    },
    "CNTR_1336769417_1760808325021": {
      "testId": "CNTR_1336769417_1760808325021",
      "timestamp": "2025-10-18T17:25:25.021Z",
      "query": "playbook for Duplicate container snapshot detected: Data quality monitor detected that container CMAU0000020 was inserted twice within one second, creating inconsistent yard inventory views.",
      "aiResponse": "Subject: ALR-861600 — Playbook: Duplicate container snapshot detected (CMAU0000020)\n\nSummary: Data quality monitor flagged duplicate snapshots for container CMAU0000020. Follow these steps to confirm, remediate (retain most recent snapshot), and force downstream consumers to pick up the corrected state. No escalation required. Primary guidance: [KB-2210] CNTR-024 (Duplicate Container information received). See also [KB-1749] for data-correction best practices.\n\nAction steps (numbered, with verification)\n\n1) ACTION 01 — Take an immediate backup of affected records (safety first)\n- Purpose: Ensure recoverability before making any DB changes.\n- Steps:\n  - Export the active rows for container CMAU0000020 and the table schema to a secure location.\n- Commands:\n  [SQL]\n  ```\n  -- Export rows for CMAU0000020 to an offline file (adjust path/user)\n  SELECT * FROM container\n   WHERE cntr_no = 'CMAU0000020'\n  INTO OUTFILE '/var/backups/cntr_CMAU0000020_$(date +%s).csv'\n  FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '\"' LINES TERMINATED BY '\\n';\n  ```\n- Verification:\n  - Confirm file exists and contains all rows found.\n  - Check checksum and store backup path in incident log.\n\n2) ACTION 02 — Detect and confirm duplicate snapshots (KB-2210)\n- Purpose: Confirm that multiple snapshot rows exist and capture evidence.\n- Steps:\n  - Query database for duplicate snapshots within short time windows.\n  - Cross-check application log entry.\n- Commands:\n  [SQL]\n  ```\n  -- Find all rows for CMAU0000020\n  SELECT id, cntr_no, version, created_at, updated_at, status, metadata\n    FROM container\n   WHERE cntr_no = 'CMAU0000020'\n   ORDER BY created_at DESC;\n  ```\n  [LOG CHECK — shell]\n  ```\n  # Search logs for the warning\n  grep \"DuplicateSnapshotAttempt\" /var/log/container_service.log | grep \"CMAU0000020\" || true\n  ```\n- Evidence to collect:\n  - DB rows (output of SQL).\n  - Log lines: \"WARN container-version DuplicateSnapshotAttempt cntr_no=CMAU0000020...\"\n- Verification:\n  - Confirm >1 row listed for CMAU0000020.\n  - Confirm the log entry exists and timestamp(s) align with DB rows.\n\n3) ACTION 03 — Identify the single snapshot to retain (most recent) (KB-2210)\n- Purpose: Decide which row represents the authoritative operational state.\n- Steps:\n  - Choose the snapshot with the latest created_at (or highest version/id if created_at identical).\n- Commands:\n  [SQL]\n  ```\n  -- Identify the single row to keep (most recent)\n  SELECT id, cntr_no, version, created_at, updated_at\n    FROM container\n   WHERE cntr_no = 'CMAU0000020'\n   ORDER BY\n     COALESCE(created_at, '1970-01-01') DESC,\n     COALESCE(version, 0) DESC,\n     id DESC\n   LIMIT 1;\n  ```\n- Verification:\n  - Note the chosen id; add to incident log as \"retain_id\".\n\n4) ACTION 04 — Archive older duplicate rows (KB-2210)\n- Purpose: Preserve history while removing inconsistent active duplicates.\n- Steps:\n  - Insert older rows into an archive table (or set archived flag) and then remove them from active table in a single transaction.\n  - Use transaction to ensure atomicity.\n- Commands:\n  [SQL]\n  ```\n  START TRANSACTION;\n\n  -- Create archive table if not exists (one-time safe op)\n  CREATE TABLE IF NOT EXISTS container_archive LIKE container;\n\n  -- Insert older rows (exclude the retained id) into archive\n  INSERT INTO container_archive\n  SELECT *, NOW() AS archived_at, 'ALR-861600 duplicate snapshot archive' AS archive_reason\n    FROM container\n   WHERE cntr_no = 'CMAU0000020'\n     AND id <> <RETAIN_ID>;\n\n  -- Remove archived rows from active table\n  DELETE FROM container\n   WHERE cntr_no = 'CMAU0000020'\n     AND id <> <RETAIN_ID>;\n\n  COMMIT;\n  ```\n  - Replace <RETAIN_ID> with the id identified in ACTION 03.\n- Verification:\n  - Run:\n    [SQL]\n    ```\n    -- Confirm only one active row remains\n    SELECT COUNT(*) as active_count\n      FROM container\n     WHERE cntr_no = 'CMAU0000020';\n    ```\n    Expect active_count = 1.\n  - Confirm archive:\n    [SQL]\n    ```\n    SELECT COUNT(*) as archived_count\n      FROM container_archive\n     WHERE cntr_no = 'CMAU0000020';\n    ```\n    Expect archived_count = (original_duplicates - 1).\n  - Save and attach results to incident evidence.\n\n5) ACTION 05 — Update DB audit/log and add incident note (operational record)\n- Purpose: Maintain traceability for the change.\n- Steps:\n  - Insert an audit row / write to incident log table that documents the action, reason, operator, timestamp, and backup location.\n- Commands:\n  [SQL]\n  ```\n  INSERT INTO incident_audit (incident_id, action, operator, notes, created_at)\n  VALUES ('ALR-861600', 'Archived duplicate container snapshots for CMAU0000020; retained id=<RETAIN_ID>', 'yard-duty-officer', 'Backup: /var/backups/..', NOW());\n  ```\n- Verification:\n  - Query incident_audit to ensure entry exists.\n\n6) ACTION 06 — Trigger downstream cache invalidation / rebuild (KB-2210)\n- Purpose: Ensure API consumers and yard inventory views pick up corrected container state.\n- Steps:\n  - Call cache invalidation and inventory rebuild endpoints (or publish a message to the sync topic).\n  - If your system provides a synchronous rebuild job, trigger it and wait for completion.\n- Commands:\n  [API]\n  ```\n  # Invalidate container cache for CMAU0000020\n  curl -s -X POST https://api.internal/cache/invalidate \\\n    -H \"Authorization: Bearer ${ADMIN_TOKEN}\" \\\n    -H \"Content-Type: application/json\" \\\n    -d '{\"keys\":[\"container:CMAU0000020\",\"yard_inventory\"]}'\n  ```\n  [API]\n  ```\n  # Trigger yard inventory rebuild (example)\n  curl -s -X POST https://api.internal/jobs/rebuild-yard-inventory \\\n    -H \"Authorization: Bearer ${ADMIN_TOKEN}\" \\\n    -H \"Content-Type: application/json\" \\\n    -d '{\"trigger\": \"ALR-861600\", \"containers\":[\"CMAU0000020\"]}'\n  ```\n  - If your system uses messaging (Kafka/Rabbit), publish a container-update event:\n  [API]\n  ```\n  # Publish a container.update event to the sync topic (example)\n  curl -s -X POST https://api.internal/events/publish \\\n    -H \"Authorization: Bearer ${ADMIN_TOKEN}\" \\\n    -H \"Content-Type: application/json\" \\\n    -d '{\"topic\":\"container.update\",\"payload\":{\"cntr_no\":\"CMAU0000020\",\"source\":\"ALR-861600\"}}'\n  ```\n- Verification:\n  - Confirm API responses show success (HTTP 200/202).\n  - Check job status or event queue metrics.\n  - Check application logs for downstream consumers acknowledging updated snapshot.\n\n7) ACTION 07 — Verify downstream consumers and yard inventory views\n- Purpose: Ensure operational systems reflect the corrected single snapshot.\n- Steps & Checks:\n  - Query the container API to confirm single snapshot data.\n  - Query yard inventory view(s) to ensure container appears correctly and counts/locations match DB.\n- Commands:\n  [API]\n  ```\n  # Verify container API\n  curl -s -X GET \"https://api.internal/containers/CMAU0000020\" \\\n    -H \"Authorization: Bearer ${READ_TOKEN}\"\n  ```\n  [API]\n  ```\n  # Verify yard inventory that includes this container (example)\n  curl -s -X GET \"https://api.internal/yard/inventory?cntr_no=CMAU0000020\" \\\n    -H \"Authorization: Bearer ${READ_TOKEN}\"\n  ```\n  [SQL]\n  ```\n  -- Cross-check DB authoritative row\n  SELECT id, cntr_no, status, location, updated_at\n    FROM container\n   WHERE cntr_no = 'CMAU0000020';\n  ```\n- Verification:\n  - API returns a single container resource that matches the authoritative DB row.\n  - Yard inventory API or UI shows the container in the expected location and count.\n  - No new \"DuplicateSnapshotAttempt\" warnings are emitted after rebuild (monitor logs for ~5-10 minutes).\n\n8) ACTION 08 — Monitor for recurrence and document root-cause (post-fix)\n- Purpose: Confirm the fix is stable and identify why duplicate snapshots were emitted.\n- Steps:\n  - Enable elevated monitoring for container snapshot events for 1–2 hours.\n  - Review upstream producers that write container snapshots (timestamp collisions, retries, race conditions).\n  - Assign follow-up to the development team if required.\n- Verification:\n  - No further duplicate attempts for CMAU0000020 appear in logs.\n  - If duplicates are detected elsewhere, open a follow-up ticket referencing ALR-861600 and KB-2210.\n\nReady to close checklist (all items required before closure)\n1. Backup of original rows saved and referenced in incident log. (Yes/No)\n2. Duplicate rows identified and archived; retained_id documented. (Yes/No)\n3. Database verification: only 1 active row remains for CMAU0000020. (Yes/No) — SQL check run.\n4. Cache invalidation and yard inventory rebuild triggered successfully. (Yes/No) — API responses captured.\n5. Downstream APIs and UI reflect corrected container state. (Yes/No)\n6. Logs monitored for recurrence for at least 1 hour with no new duplicates. (Yes/No)\n7. Incident audit record created with operator, time, backup path, and commands used. (Yes/No)\n8. If root-cause not immediately clear, follow-up ticket created and assigned. (Yes/No)\n\nNotes, references and evidence\n- Primary KB: [KB-2210] CNTR-024 — Duplicate Container information received — use steps 1–3 regarding detecting and retaining most recent snapshot.\n- Related KB: [KB-1749] — Data correction and audit best practices.\n- Evidence collected:\n  - container_service.log: WARN container-version DuplicateSnapshotAttempt cntr_no=CMAU0000020...\n  - DB export file: /var/backups/cntr_CMAU0000020_<ts>.csv\n  - SQL results showing pre- and post-change row counts.\n  - API responses from cache invalidation and rebuild jobs.\n\nPost-actions / recommendations\n- Root-cause analysis: check producer retry logic and snapshot deduplication code path. If duplicates result from concurrent producers, recommend introducing dedupe by unique constraint (if applicable) or stronger idempotency token in snapshot payload — coordinate with dev team.\n- If duplicate snapshots occur across more containers, run a detection query and consider a batch archival procedure (follow KB-2210 guidance).\n\nIf you want, I can:\n- Populate the exact SQL with the retain_id after you provide the retained row id.\n- Draft the text block for the incident_audit insert with precise backup path and operator name.\n- Open a follow-up ticket template for engineering to investigate producer behavior.\n\nReady to close? Reply with confirmation for each checklist item or attach the verification outputs and I'll mark ALR-861600 as resolved.",
      "module": "CNTR",
      "expectedOutcome": null,
      "results": {
        "procedureCompliance": {
          "score": 70,
          "issues": [
            "Missing required step: validate container status",
            "Missing required step: check location data",
            "Missing required step: verify ownership"
          ],
          "category": "procedure_compliance"
        },
        "accuracyCheck": {
          "score": 85,
          "issues": [
            "Missing container status check"
          ],
          "category": "accuracy"
        },
        "safetyValidation": {
          "score": 75,
          "issues": [
            "Missing safety consideration: proper documentation"
          ],
          "category": "safety"
        },
        "completenessCheck": {
          "score": 100,
          "issues": [],
          "category": "completeness"
        },
        "clarityScore": {
          "score": 100,
          "issues": [],
          "category": "clarity"
        }
      },
      "overallScore": 86,
      "passed": true
    },
    "CNTR_1336769417_1760850532127": {
      "testId": "CNTR_1336769417_1760850532127",
      "timestamp": "2025-10-19T05:08:52.127Z",
      "query": "playbook for Duplicate container snapshot detected: Data quality monitor detected that container CMAU0000020 was inserted twice within one second, creating inconsistent yard inventory views.",
      "aiResponse": "Incident: ALR-861600 — Duplicate container snapshot detected (CMAU0000020)\nChannel: Email | Persona: Yard Duty Officer\nKB refs: [KB-2210] CNTR: Duplicate Container information received (CNTR-024); see also retention/archive guidance [KB-1749]\n\nSummary: Data monitor flagged two container snapshots for CMAU0000020 inserted within one second. Follow the playbook below to detect, remediate (archive older duplicate rows), rebuild downstream cache consumers, and verify corrected inventory views.\n\nAction playbook (numbered steps with verification)\n\n1) Step 1 — Detect duplicate snapshots (Confirm issue)\n   - Purpose: Confirm duplicates exist and capture identifying fields (row_id, created_at).\n   - Commands (SQL):\n     ```sql\n     -- type: SQL\n     SELECT id, cntr_no, created_at, updated_at, status, other_meta\n     FROM container\n     WHERE cntr_no = 'CMAU0000020'\n     ORDER BY created_at ASC;\n     ```\n     - Alternate to show duplicates within 1 second:\n     ```sql\n     -- type: SQL\n     SELECT id, cntr_no, created_at,\n            lead(created_at) OVER (PARTITION BY cntr_no ORDER BY created_at) AS next_created_at\n     FROM container\n     WHERE cntr_no = 'CMAU0000020';\n     ```\n   - Verification:\n     - Confirm result shows >1 row for CMAU0000020.\n     - Confirm timestamps are within one second of each other and match the container_service.log evidence.\n     - Save query output (screenshot/CSV) into incident folder.\n\n2) Step 2 — Create backups & change-control note (Safety / recoverability)\n   - Purpose: Ensure rollback capability and audit trail before modifying DB.\n   - Actions:\n     - Take a DB dump for the container table or relevant partition.\n     - Record start time and transaction id in incident log.\n   - Commands (SQL / shell):\n     ```sql\n     -- type: SQL (export)\n     -- Example: export affected rows to an audit table/file\n     CREATE TABLE IF NOT EXISTS container_audit_backup AS\n     SELECT * FROM container WHERE cntr_no = 'CMAU0000020';\n     ```\n     Or shell DB dump:\n     ```bash\n     # type: SHELL\n     pg_dump -t container --data-only --file=backup_container_CMAU0000020.sql --dbname=portdb\n     ```\n   - Verification:\n     - Confirm backup file/container_audit_backup contains the duplicate rows.\n     - Note backup file name and location in the incident record.\n\n3) Step 3 — Identify the most recent (canonical) snapshot to keep\n   - Purpose: Determine which row represents the current operational state (most recent created_at / version).\n   - Command (SQL):\n     ```sql\n     -- type: SQL\n     SELECT id AS keep_id, cntr_no, created_at, updated_at, status\n     FROM container\n     WHERE cntr_no = 'CMAU0000020'\n     ORDER BY created_at DESC, updated_at DESC\n     LIMIT 1;\n     ```\n   - Verification:\n     - Confirm keep_id is the row with latest created_at (and/or highest version).\n     - Record keep_id in incident notes.\n\n4) Step 4 — Archive older duplicate rows (non-destructive)\n   - Purpose: Move older duplicates to archive table (preserve data and history) and ensure only the most recent remains active.\n   - Approach: Insert older rows into container_archive (with archive metadata), then delete or update original rows to mark archived. Use a transaction.\n   - Commands (SQL):\n     ```sql\n     -- type: SQL\n     BEGIN;\n\n     -- create archive table if not present\n     CREATE TABLE IF NOT EXISTS container_archive AS TABLE container WITH NO DATA;\n\n     -- insert older duplicates into archive with metadata\n     INSERT INTO container_archive\n     SELECT *, now() AS archived_at, 'ALR-861600 duplicate archive' AS archive_reason\n     FROM container\n     WHERE cntr_no = 'CMAU0000020' AND id <> <KEEP_ID>;\n\n     -- delete older duplicates from live table\n     DELETE FROM container\n     WHERE cntr_no = 'CMAU0000020' AND id <> <KEEP_ID>;\n\n     COMMIT;\n     ```\n     - Replace <KEEP_ID> with the id determined in Step 3.\n   - Alternative (soft-archive):\n     ```sql\n     -- type: SQL\n     UPDATE container\n     SET status = 'archived',\n         archive_reason = 'ALR-861600 duplicate',\n         archived_at = now()\n     WHERE cntr_no = 'CMAU0000020' AND id <> <KEEP_ID>;\n     ```\n   - Verification:\n     - Run:\n       ```sql\n       -- type: SQL\n       SELECT COUNT(*) FROM container WHERE cntr_no = 'CMAU0000020';\n       SELECT COUNT(*) FROM container_archive WHERE cntr_no = 'CMAU0000020';\n       ```\n     - Expected: container count = 1; container_archive count = number of removed rows (>0).\n     - Confirm archive entries include archived_at and archive_reason.\n     - Record transaction id and DB audit logs.\n\n5) Step 5 — Rebuild cache consumers / trigger downstream sync (KB-2210)\n   - Purpose: Ensure downstream APIs, caches, and consumer services reflect the corrected snapshot.\n   - Actions:\n     - Trigger container-level sync for CMAU0000020 and, if available, full container cache rebuild.\n   - Example API calls:\n     ```http\n     -- type: API\n     POST /api/internal/sync/container/CMAU0000020\n     Host: internal-port-api\n     Authorization: Bearer <SERVICE_TOKEN>\n     Content-Type: application/json\n\n     { \"reason\": \"ALR-861600 duplicate remediation\", \"force\": true }\n     ```\n     - For full cache flush (if needed):\n     ```http\n     -- type: API\n     POST /api/internal/cache/flush\n     Host: cache-manager\n     Authorization: Bearer <SERVICE_TOKEN>\n     Content-Type: application/json\n\n     { \"scope\": \"container\", \"cntr_no\": \"CMAU0000020\" }\n     ```\n     - If using a message queue:\n     ```json\n     -- type: API\n     PUSH to topic: container.sync.requests\n     payload: { \"cntr_no\": \"CMAU0000020\", \"action\": \"resync\", \"reason\":\"ALR-861600\" }\n     ```\n   - Verification:\n     - Confirm API returns success (200/202) and logs show resync processed.\n     - Query cache/status endpoint to confirm last_sync timestamp updated:\n       ```http\n       -- type: API\n       GET /api/internal/containers/CMAU0000020/status\n       ```\n     - Check application logs for reindex/consumer confirmation.\n\n6) Step 6 — Verify yard inventory and downstream consumers\n   - Purpose: Confirm that the corrected snapshot is visible and consistent in yard inventory views and downstream APIs.\n   - Verification queries / checks:\n     - DB check:\n       ```sql\n       -- type: SQL\n       SELECT id, cntr_no, created_at, status FROM container WHERE cntr_no='CMAU0000020';\n       ```\n       Expect exactly 1 row.\n     - Data quality check:\n       ```sql\n       -- type: SQL\n       SELECT COUNT(*) FROM container WHERE cntr_no='CMAU0000020' AND created_at IS NULL;\n       ```\n     - API check (public consumer):\n       ```http\n       -- type: API\n       GET /api/containers/CMAU0000020\n       Host: public-api\n       ```\n       Expect returned state matches the keep row.\n     - Log check:\n       - Tail container_service.log for 5-10 minutes to ensure no further DuplicateSnapshotAttempt warnings for CMAU0000020:\n       ```bash\n       # type: SHELL\n       grep 'DuplicateSnapshotAttempt.*CMAU0000020' /var/log/container_service.log || tail -n 200 /var/log/container_service.log\n       ```\n     - Monitoring:\n       - Ensure downstream systems (yard app, gate, stacking planner) show the same container state; perform a quick manual spot-check on UIs used by yard ops.\n\n7) Step 7 — Temporary monitoring & prevent recurrence\n   - Purpose: Detect if duplicates re-occur and identify upstream source.\n   - Actions:\n     - Create a temporary alert rule to notify if DuplicateSnapshotAttempt for CMAU0000020 (or any container) occurs more than once in X minutes.\n     - Investigate upstream sources that generated duplicate snapshot events (ingress service, message retry logic).\n   - Example monitoring CLI:\n     ```bash\n     # type: SHELL\n     # Add a temp grep-based check or hook to logging/alerting system\n     watch -n 60 \"grep 'DuplicateSnapshotAttempt' /var/log/container_service.log | grep 'CMAU0000020' | wc -l\"\n     ```\n   - Verification:\n     - Confirm alerts configured and tested (simulate a benign duplicate test if safe).\n     - Record any root-cause findings; if root cause is internal process (retry logic), coordinate corrective action with dev team and link to KB-2210.\n\n8) Step 8 — Document actions and update KB / close incident\n   - Purpose: Ensure audit/compliance and knowledge capture.\n   - Required documentation:\n     - Add entries to incident ticket:\n       - Step-by-step actions, timestamp, keep_id, archive ids, backup file paths, API calls made, operator initials.\n     - Reference KB-2210 and KB-1749 in the ticket.\n   - Ready to close checklist (see below).\n\nReady to close checklist (must verify all before closing)\n   - [ ] Detection: Confirmed duplicates existed for CMAU0000020 and captured evidence (query output + container_service.log).\n   - [ ] Backup: DB export and/or container_audit_backup created and verified.\n   - [ ] Archive: Older duplicate rows moved to container_archive (or soft-archived) and verified. Live container table contains exactly one row for CMAU0000020.\n   - [ ] Cache rebuild: Downstream cache/API consumers resynced; API returns consistent state.\n   - [ ] Logs: No further DuplicateSnapshotAttempt entries for CMAU0000020 in the monitoring window (e.g., 30 minutes post-remediation).\n   - [ ] Monitoring: Temporary alert enabled to detect recurrence and owner assigned.\n   - [ ] Documentation: Incident record updated with actions, queries, backup names, and KB references [KB-2210], [KB-1749].\n   - [ ] No escalation required: Confirmed — no escalation needed per policy; if recurrence or root-cause requires dev-team, create follow-up ticket.\n\nNotes / Guidance & references\n   - Follow remediation guidance in [KB-2210] CNTR-024 for duplicate snapshot handling and retention best practice.\n   - Use [KB-1749] for archival retention policy and naming conventions (archive_reason, archived_at).\n   - Keep remediation non-destructive where possible (archive vs delete) to preserve audit trail.\n   - Prioritize yard operational safety: apply changes during a low-activity window if live operations could be affected; coordinate with TOS operators.\n\nIf you want, I can:\n   - Generate the exact SQL with the keep_id filled in once you provide the keep_id from Step 3.\n   - Produce the exact curl commands with tokens masked for the API calls to run immediately.\n   - Draft the incident update text for the ticket including the readiness checklist.",
      "module": "CNTR",
      "expectedOutcome": null,
      "results": {
        "procedureCompliance": {
          "score": 70,
          "issues": [
            "Missing required step: validate container status",
            "Missing required step: check location data",
            "Missing required step: verify ownership"
          ],
          "category": "procedure_compliance"
        },
        "accuracyCheck": {
          "score": 100,
          "issues": [],
          "category": "accuracy"
        },
        "safetyValidation": {
          "score": 100,
          "issues": [],
          "category": "safety"
        },
        "completenessCheck": {
          "score": 100,
          "issues": [],
          "category": "completeness"
        },
        "clarityScore": {
          "score": 100,
          "issues": [],
          "category": "clarity"
        }
      },
      "overallScore": 94,
      "passed": true
    },
    "CNTR_1336769417_1760866491656": {
      "testId": "CNTR_1336769417_1760866491656",
      "timestamp": "2025-10-19T09:34:51.656Z",
      "query": "playbook for Duplicate container snapshot detected: Data quality monitor detected that container CMAU0000020 was inserted twice within one second, creating inconsistent yard inventory views.",
      "aiResponse": "Incident: ALR-861600 — Duplicate container snapshot detected (CMAU0000020)\nPersona: Yard Duty Officer\nReference: KB [KB-2210] \"Duplicate Container information received (CNTR-024)\"\n\nAction playbook — numbered steps with verification\n\n1) Step 1 — Confirm duplicates and capture evidence (Detect)\n   - Purpose: Verify multiple snapshots exist for CMAU0000020 before any change (KB-2210 Step 1).\n   - Actions:\n     1. Query DB for all rows for the container, ordered newest→oldest.\n```SQL\n-- TYPE: SQL\nSELECT id, cntr_no, created_at, version, snapshot_hash\nFROM container\nWHERE cntr_no = 'CMAU0000020'\nORDER BY created_at DESC;\n```\n     2. Check service log for DuplicateSnapshotAttempt evidence.\n```bash\n# TYPE: SHELL\ngrep \"DuplicateSnapshotAttempt\" /var/log/container_service.log | grep \"CMAU0000020\" || true\n```\n   - Verification:\n     - Confirm >1 row returned by SQL and timestamps within one second or identical version/hash.\n     - Confirm log warnings exist (container_service.log contains DuplicateSnapshotAttempt cntr_no=CMAU0000020).\n     - Save output (SQL result and log snippets) to the incident record as evidence.\n\n2) Step 2 — Backup relevant records (Safe state)\n   - Purpose: Create an immutable backup before any modification.\n   - Actions:\n     1. Export the identified rows to a safe backup table/file transactionally.\n```SQL\n-- TYPE: SQL\nBEGIN;\nCREATE TABLE IF NOT EXISTS container_backup_incident_ALR_861600 AS\nSELECT *, now() AS backed_up_at\nFROM container\nWHERE cntr_no = 'CMAU0000020';\nCOMMIT;\n```\n     2. Optionally export to file (DB admin / storage policy).\n```bash\n# TYPE: SHELL\npsql -d fleetdb -c \"\\copy (SELECT * FROM container WHERE cntr_no='CMAU0000020') TO '/tmp/CMAU0000020_backup.csv' CSV HEADER\"\n```\n   - Verification:\n     - Confirm backup table contains all pre-change rows.\n```SQL\n-- TYPE: SQL\nSELECT count(*) FROM container_backup_incident_ALR_861600;\n```\n     - Confirm backup file exists and is readable if exported.\n\n3) Step 3 — Retain most recent snapshot and archive older duplicates (Remediate) (KB-2210 Step 2)\n   - Purpose: Keep the latest operational snapshot, archive older rows to preserve audit/history.\n   - Actions (perform inside a transaction; obtain DB lock if high-concurrency):\n     1. Identify the most recent row id.\n```SQL\n-- TYPE: SQL\nSELECT id\nFROM container\nWHERE cntr_no='CMAU0000020'\nORDER BY created_at DESC, version DESC\nLIMIT 1;\n```\n     2. Archive older rows into an archive table with reason and actor, then remove them from main table.\n```SQL\n-- TYPE: SQL\nBEGIN;\n\n-- Ensure archive table exists\nCREATE TABLE IF NOT EXISTS container_archive (\n  id BIGINT PRIMARY KEY,\n  cntr_no TEXT,\n  created_at TIMESTAMP,\n  version INT,\n  snapshot_data JSONB,\n  archived_at TIMESTAMP,\n  archive_reason TEXT,\n  archived_by TEXT\n);\n\n-- Move older snapshots to archive\nINSERT INTO container_archive (id, cntr_no, created_at, version, snapshot_data, archived_at, archive_reason, archived_by)\nSELECT id, cntr_no, created_at, version, snapshot_data, now(), 'Duplicate snapshot cleanup (ALR-861600) - older than latest', 'yard-duty-officer'\nFROM container\nWHERE cntr_no='CMAU0000020'\n  AND id NOT IN (\n    SELECT id FROM container WHERE cntr_no='CMAU0000020' ORDER BY created_at DESC, version DESC LIMIT 1\n  );\n\n-- Delete moved rows from production table\nDELETE FROM container\nWHERE cntr_no='CMAU0000020'\n  AND id NOT IN (\n    SELECT id FROM container WHERE cntr_no='CMAU0000020' ORDER BY created_at DESC, version DESC LIMIT 1\n  );\n\nCOMMIT;\n```\n   - Verification:\n     - Confirm exactly one row remains in production table.\n```SQL\n-- TYPE: SQL\nSELECT count(*) AS remaining, min(created_at) AS earliest, max(created_at) AS latest\nFROM container\nWHERE cntr_no='CMAU0000020';\n```\n     - Confirm archive table contains the older rows with archived_at and archive_reason.\n```SQL\n-- TYPE: SQL\nSELECT count(*) FROM container_archive WHERE cntr_no='CMAU0000020' AND archive_reason LIKE '%ALR-861600%';\n```\n     - Record IDs of archived rows in incident ticket.\n\n4) Step 4 — Prevent immediate reoccurrence (Mitigation)\n   - Purpose: Stop the duplicate snapshot source while fixes propagate.\n   - Actions:\n     - If possible, temporarily pause or throttle the snapshot producer for this container (consumer/service config) or apply a short-lived DB constraint where safe.\n     - Recommended: Add a brief write-guard for cntr_no uniqueness on (cntr_no, created_at) or improve dedupe logic—coordinate with platform/DB team if schema changes required (no schema change in this playbook without change control).\n   - Verification:\n     - Confirm that producers are paused/throttled (service status/logs).\n     - Confirm no new container rows for CMAU0000020 are created during remediation (monitor for 5–10 min).\n\n5) Step 5 — Rebuild cache / trigger downstream sync (KB-2210 Step 3)\n   - Purpose: Ensure API and cache consumers pick up corrected snapshot.\n   - Actions:\n     1. Trigger downstream cache rebuild / publish a container-update event for CMAU0000020.\n```bash\n# TYPE: API\ncurl -X POST \"https://internal-api.example.local/v1/containers/CMAU0000020/sync\" \\\n  -H \"Authorization: Bearer $INTERNAL_TOKEN\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"reason\":\"ALR-861600 duplicate snapshot cleanup\",\"triggered_by\":\"yard-duty-officer\"}'\n```\n     2. If a generic cache rebuild endpoint is available:\n```bash\n# TYPE: API\ncurl -X POST \"https://internal-api.example.local/v1/cache/rebuild?scope=container&cntr=CMAU0000020\" \\\n  -H \"Authorization: Bearer $INTERNAL_TOKEN\"\n```\n     3. If using messaging, publish event to the container topic with latest snapshot id.\n```bash\n# TYPE: SHELL\n# Example Kafka publish (adjust per environment)\nkafka-console-producer --broker-list brokers:9092 --topic container-updates <<EOF\n{\"cntr_no\":\"CMAU0000020\",\"action\":\"resync\",\"source\":\"ALR-861600\",\"payload_id\":<LATEST_ID>}\nEOF\n```\n   - Verification:\n     - Query API endpoint to confirm returned snapshot matches DB latest row.\n```bash\n# TYPE: API\ncurl -s \"https://public-api.example.local/v1/containers/CMAU0000020\" | jq .\n```\n     - Confirm cache service logs show a successful rebuild for CMAU0000020.\n```bash\n# TYPE: SHELL\ngrep \"cache-rebuild\" /var/log/cache_service.log | grep \"CMAU0000020\" || true\n```\n     - Confirm downstream services (e.g., yard UI, slotting consumers) now return consistent data.\n\n6) Step 6 — Validate with Data Quality Monitor and logs (Verify)\n   - Purpose: Confirm the data quality alert is cleared and no further duplicate attempts occur.\n   - Actions:\n     1. Re-run the DQM query or service that raised ALR-861600.\n```SQL\n-- TYPE: SQL\n-- Example DQM: find containers with >1 snapshot within 1 second\nSELECT cntr_no, count(*) AS cnt, min(created_at), max(created_at)\nFROM container\nWHERE cntr_no='CMAU0000020'\nGROUP BY cntr_no\nHAVING count(*) > 1;\n```\n     2. Tail logs for the last 30 minutes for new DuplicateSnapshotAttempt for this container.\n```bash\n# TYPE: SHELL\ntail -n 500 /var/log/container_service.log | grep \"DuplicateSnapshotAttempt\" | grep \"CMAU0000020\" || true\n```\n   - Verification:\n     - DQM returns no rows for CMAU0000020.\n     - No new DuplicateSnapshotAttempt log entries after remediation time.\n     - Downstream APIs return expected single snapshot.\n\n7) Step 7 — Document, notify, and close (Operations)\n   - Purpose: Complete incident record and ensure stakeholders are informed.\n   - Actions:\n     - Update incident ALR-861600 with:\n       - Evidence saved in Step 1 and backups from Step 2.\n       - SQL statements executed and archived IDs (Step 3).\n       - API/cache rebuild confirmation logs (Step 5).\n       - DQM validation results (Step 6).\n       - Reference KB [KB-2210] and note that remediation followed KB steps.\n     - Notify Yard Ops and relevant platform teams that issue is resolved; include \"No escalation required\" in notification.\n   - Verification:\n     - Confirm recipients acknowledge receipt.\n     - Confirm monitoring will continue for next 24 hours for recurrence.\n\nReady to close — checklist\n  - [ ] Duplicates confirmed and evidence captured (SQL + logs)\n  - [ ] Backup of pre-change rows completed and stored (container_backup_incident_ALR_861600)\n  - [ ] Older duplicate snapshots archived with reason and actor (container_archive entries)\n  - [ ] Production container table contains single, correct latest snapshot\n  - [ ] Cache/consumers rebuilt and API returns consistent data\n  - [ ] Data Quality Monitor shows no remaining duplicate condition for CMAU0000020\n  - [ ] Logs show no new DuplicateSnapshotAttempt for CMAU0000020 after remediation\n  - [ ] Incident record updated with steps, evidence, and KB [KB-2210] reference\n  - [ ] Stakeholders notified (Yard Ops, Platform) and closure acknowledged\n\nNotes / Guidance:\n  - All actions followed KB [KB-2210] “Duplicate Container information received (CNTR-024)” recommendations: detect first, retain latest, archive older rows, then rebuild consumers.\n  - Avoid destructive operations outside this playbook. If schema changes or permanent constraints are needed to prevent recurrence, schedule through change control and coordinate with platform DB team.\n  - If duplicates reoccur after remediation, escalate to Platform Ops with logs, producer ID, and timestamps (then open a separate incident).\n\nIf you want, I can:\n  - Provide an automated SQL script wrapping Steps 1–3 for DBA execution, or\n  - Draft the notification text to send to Yard Ops and Platform teams.",
      "module": "CNTR",
      "expectedOutcome": null,
      "results": {
        "procedureCompliance": {
          "score": 70,
          "issues": [
            "Missing required step: validate container status",
            "Missing required step: check location data",
            "Missing required step: verify ownership"
          ],
          "category": "procedure_compliance"
        },
        "accuracyCheck": {
          "score": 85,
          "issues": [
            "Missing container status check"
          ],
          "category": "accuracy"
        },
        "safetyValidation": {
          "score": 75,
          "issues": [
            "Missing safety consideration: proper documentation"
          ],
          "category": "safety"
        },
        "completenessCheck": {
          "score": 100,
          "issues": [],
          "category": "completeness"
        },
        "clarityScore": {
          "score": 100,
          "issues": [],
          "category": "clarity"
        }
      },
      "overallScore": 86,
      "passed": true
    },
    "CNTR_1336769417_1760868226978": {
      "testId": "CNTR_1336769417_1760868226978",
      "timestamp": "2025-10-19T10:03:46.978Z",
      "query": "playbook for Duplicate container snapshot detected: Data quality monitor detected that container CMAU0000020 was inserted twice within one second, creating inconsistent yard inventory views.",
      "aiResponse": "{\n  \"importantSafetyNotes\": [\n    \"Do not authorize physical moves or lift operations for container CMAU0000020 until yard inventory is confirmed consistent.\",\n    \"Take a full database backup before any DELETE/UPDATE/archive actions to allow safe rollback.\",\n    \"Perform live data changes during a quiet yard window where possible and notify operations control to prevent manual workflows relying on inconsistent inventory.\",\n    \"If you are not the DBA or do not have DB admin privileges, escalate DB changes to the DBA team rather than executing them yourself.\"\n  ],\n  \"actionSteps\": [\n    {\n      \"stepTitle\": \"Detect duplicate snapshots (Confirm existence) [Run: database & log host] (KB-2210, KB-1749)\",\n      \"executionContext\": \"database (SQL) and application host (shell - logs)\",\n      \"procedure\": [\n        \"Run a query to list all snapshot rows for cntr_no=CMAU0000020 and confirm duplicates exist.\",\n        \"Inspect container_service.log for 'DuplicateSnapshotAttempt' warnings to capture timestamps and context.\",\n        \"Record the rows (ids, snapshot_time, created_at, payload) as evidence prior to any change.\"\n      ]\n    },\n    {\n      \"stepTitle\": \"Backup affected data (Safety: mandatory) [Run: database export] (KB-2210)\",\n      \"executionContext\": \"database (SQL) or DB export utility on DB host\",\n      \"procedure\": [\n        \"Export all container_snapshot rows for CMAU0000020 to a local backup file and store in secured location with timestamped filename.\",\n        \"If available, create a database-level backup/snapshot (dump) covering the affected table.\",\n        \"Log backup file path and checksum in the incident record.\"\n      ]\n    },\n    {\n      \"stepTitle\": \"Retain most recent snapshot only (Archive older rows) [Run: database transaction] (KB-2210)\",\n      \"executionContext\": \"database (SQL) executed by DBA or authorized operator\",\n      \"procedure\": [\n        \"Within a transaction, insert older duplicate rows into container_snapshot_archive (or an audit table) including who archived and timestamp.\",\n        \"Delete or mark as archived the older duplicate rows so only the most recent snapshot remains in the active table.\",\n        \"Commit transaction and verify only a single active snapshot row exists for CMAU0000020.\"\n      ]\n    },\n    {\n      \"stepTitle\": \"Rebuild cache consumers and trigger downstream sync [Run: API / service restart] (KB-2210)\",\n      \"executionContext\": \"application/API host and cache service (HTTP/API or service manager)\",\n      \"procedure\": [\n        \"Trigger or call the internal cache rebuild/sync endpoint for the specific container or restart the cache service to force readers to pick up corrected snapshot.\",\n        \"If there are multiple downstream consumers (API gateways, yard UI caches), invoke their invalidation/sync operations per runbook.\",\n        \"Verify consumers now report a single consistent inventory view for CMAU0000020.\"\n      ]\n    },\n    {\n      \"stepTitle\": \"Validate and monitor (Confirm resolution) [Run: database, logs, application] (KB-2210)\",\n      \"executionContext\": \"database (SQL), application logs (shell), monitoring dashboards\",\n      \"procedure\": [\n        \"Re-run the detection query to confirm only one active snapshot exists for CMAU0000020.\",\n        \"Scan container_service.log and consumer logs for new 'DuplicateSnapshotAttempt' warnings during the monitoring window.\",\n        \"Monitor relevant dashboards and queue consumers for at least the agreed observation window (e.g., 24 hours) to ensure no recurrence.\"\n      ]\n    },\n    {\n      \"stepTitle\": \"Communication and incident closure (Operational) [Run: email / incident tracker] (KB-2210)\",\n      \"executionContext\": \"email and incident management system (console/API)\",\n      \"procedure\": [\n        \"Send an email to yard ops, terminal control, and stakeholders describing actions taken, evidence (backup location and SQL outputs), and the monitoring plan.\",\n        \"Attach the backup identifier and the confirmation query results to the incident record ALR-861600.\",\n        \"If stable after monitoring window, mark incident as resolved with notes referencing KB-2210 and archival location; no escalation required.\"\n      ]\n    }\n  ],\n  \"languageCommands\": [\n    {\n      \"language\": \"sql\",\n      \"command\": \"SELECT id, cntr_no, snapshot_time, created_at, payload FROM container_snapshot WHERE cntr_no='CMAU0000020' ORDER BY snapshot_time DESC, id DESC;\"\n    },\n    {\n      \"language\": \"sql\",\n      \"command\": \"COPY (SELECT * FROM container_snapshot WHERE cntr_no='CMAU0000020') TO '/tmp/CMAU0000020_backup_`date +%Y%m%d%H%M%S`.csv' WITH CSV HEADER;\"\n    },\n    {\n      \"language\": \"sql\",\n      \"command\": \"BEGIN; INSERT INTO container_snapshot_archive (id, cntr_no, snapshot_time, payload, created_at, archived_by, archived_at) SELECT id, cntr_no, snapshot_time, payload, created_at, 'ops:ALR-861600', now() FROM container_snapshot WHERE cntr_no='CMAU0000020' AND id NOT IN (SELECT id FROM container_snapshot WHERE cntr_no='CMAU0000020' ORDER BY snapshot_time DESC, id DESC LIMIT 1); DELETE FROM container_snapshot WHERE cntr_no='CMAU0000020' AND id NOT IN (SELECT id FROM container_snapshot WHERE cntr_no='CMAU0000020' ORDER BY snapshot_time DESC, id DESC LIMIT 1); COMMIT;\"\n    },\n    {\n      \"language\": \"bash\",\n      \"command\": \"grep -n \\\"DuplicateSnapshotAttempt\\\" /var/log/container_service.log | grep \\\"CMAU0000020\\\" || true\"\n    },\n    {\n      \"language\": \"bash\",\n      \"command\": \"curl -s -X POST \\\"http://localhost:8080/internal/api/v1/cache/rebuild\\\" -H \\\"Content-Type: application/json\\\" -d '{\\\"cntr_no\\\":\\\"CMAU0000020\\\"}'\"\n    },\n    {\n      \"language\": \"bash\",\n      \"command\": \"curl -s -X POST \\\"http://api-gateway.internal/containers/sync/CMAU0000020\\\" -H \\\"Content-Type: application/json\\\"\"\n    }\n  ],\n  \"checklists\": [\n    {\n      \"title\": \"Pre-change checklist\",\n      \"items\": [\n        \"Confirm duplicate snapshot rows exist with detection query and capture output.\",\n        \"Take DB-level backup or export affected rows and record file location/checksum.\",\n        \"Notify yard operations and schedule change during low activity if possible.\",\n        \"Ensure DBA or authorized operator is present to run transactional archive/delete commands.\"\n      ]\n    },\n    {\n      \"title\": \"Validation checklist\",\n      \"items\": [\n        \"Active container_snapshot table shows only one row for CMAU0000020.\",\n        \"container_service.log no longer shows 'DuplicateSnapshotAttempt' for CMAU0000020 after remediation.\",\n        \"Downstream API/cache consumers report the corrected snapshot state.\",\n        \"Monitoring shows no recurrence for the agreed observation window (e.g., 24 hours).\"\n      ]\n    },\n    {\n      \"title\": \"Ready to close\",\n      \"items\": [\n        \"All validation checklist items completed and evidence attached to incident ALR-861600.\",\n        \"Backup and archive locations documented in the incident record.\",\n        \"Operations and stakeholders informed by email with actions taken and monitoring plan.\",\n        \"Incident updated with reference to KB-2210 (CNTR-024) and KB-1749 as applicable, and closed as 'No escalation required'.\"\n      ]\n    }\n  ]\n}",
      "module": "CNTR",
      "expectedOutcome": null,
      "results": {
        "procedureCompliance": {
          "score": 70,
          "issues": [
            "Missing required step: validate container status",
            "Missing required step: check location data",
            "Missing required step: verify ownership"
          ],
          "category": "procedure_compliance"
        },
        "accuracyCheck": {
          "score": 85,
          "issues": [
            "Missing container status check"
          ],
          "category": "accuracy"
        },
        "safetyValidation": {
          "score": 75,
          "issues": [
            "Missing safety consideration: proper documentation"
          ],
          "category": "safety"
        },
        "completenessCheck": {
          "score": 100,
          "issues": [],
          "category": "completeness"
        },
        "clarityScore": {
          "score": 100,
          "issues": [],
          "category": "clarity"
        }
      },
      "overallScore": 86,
      "passed": true
    },
    "CNTR_1336769417_1760868597285": {
      "testId": "CNTR_1336769417_1760868597285",
      "timestamp": "2025-10-19T10:09:57.285Z",
      "query": "playbook for Duplicate container snapshot detected: Data quality monitor detected that container CMAU0000020 was inserted twice within one second, creating inconsistent yard inventory views.",
      "aiResponse": "{\n  \"importantSafetyNotes\": [\n    \"Always take a full backup of production data before modifying rows — do not delete without backup.\",\n    \"Perform schema/data changes during a low-activity window or maintenance window to avoid inventory race conditions.\",\n    \"Notify yard operations if any action may temporarily change API/GUI inventory views.\",\n    \"Do not escalate — this incident is informational and remediable without higher-level escalation as per guidance.\"\n  ],\n  \"actionSteps\": [\n    {\n      \"stepTitle\": \"Detect duplicate snapshots (database)\",\n      \"executionContext\": \"database (PostgreSQL or compatible RDBMS)\",\n      \"procedure\": [\n        \"Confirm duplicates exist for cntr_no=CMAU0000020 as described in [KB-2210].\",\n        \"Run a targeted query to list all rows and timestamps for the container to verify multiple snapshots and capture IDs for later reference.\",\n        \"Preserve the SELECT output as evidence in the incident record.\"\n      ]\n    },\n    {\n      \"stepTitle\": \"Create an immediate backup of container data (shell vs DB)\",\n      \"executionContext\": \"shell (database host) and database\",\n      \"procedure\": [\n        \"Take a logical dump of the container table or create a quick point-in-time copy before any change.\",\n        \"If using Postgres, create a copy table container_backup_<timestamp> or run pg_dump for the table.\",\n        \"Record backup location and checksum as evidence before proceeding.\"\n      ]\n    },\n    {\n      \"stepTitle\": \"Archive older duplicate rows (database)\",\n      \"executionContext\": \"database (PostgreSQL or compatible)\",\n      \"procedure\": [\n        \"Using the duplicate detection step, identify rows older than the most recent snapshot and move them to an archive table per [KB-2210].\",\n        \"Perform the archive copy and deletion in a transaction to avoid transient inconsistency.\",\n        \"Keep only the most recent snapshot row in the live container table; preserve older rows in container_archive for audit.\"\n      ]\n    },\n    {\n      \"stepTitle\": \"Verify live state and logs (database + shell)\",\n      \"executionContext\": \"database and application server shell (logs)\",\n      \"procedure\": [\n        \"Confirm only one live snapshot exists for CMAU0000020 via SELECT; compare snapshot_ts value against the archived rows to ensure the latest row remains.\",\n        \"Search application logs (container_service.log) for DuplicateSnapshotAttempt warnings and note timestamps; verify that no new duplicate attempts occurred after remediation.\",\n        \"Attach verification results to the incident evidence.\"\n      ]\n    },\n    {\n      \"stepTitle\": \"Rebuild cache consumers / trigger downstream sync (API or service control)\",\n      \"executionContext\": \"API or service control plane (internal cache/invalidation endpoint or message queue)\",\n      \"procedure\": [\n        \"Trigger downstream cache invalidation or synchronization so API consumers and GUIs pick up the corrected snapshot per [KB-2210].\",\n        \"If available, call the internal cache refresh endpoint or publish an update event to the downstream topic so all consumers reconcile.\",\n        \"Verify consumers return the corrected inventory view and document responses.\"\n      ]\n    },\n    {\n      \"stepTitle\": \"Notify stakeholders and close incident (email/ticket)\",\n      \"executionContext\": \"email / incident tracker\",\n      \"procedure\": [\n        \"Email Yard Duty Officer and relevant ops teams summarizing actions taken, backup location, and verification evidence.\",\n        \"Update incident ticket ALR-861600 with linked backup, SQL statements run, log excerpts, and confirmation that no escalation is required.\",\n        \"Run through the 'Ready to close' checklist and close the incident when all items are satisfied.\"\n      ]\n    }\n  ],\n  \"languageCommands\": [\n    {\n      \"language\": \"sql\",\n      \"command\": \"-- 1) Detect duplicates\\nSELECT cntr_no, id, snapshot_ts, created_at FROM container WHERE cntr_no='CMAU0000020' ORDER BY snapshot_ts DESC, id DESC; -- [KB-2210]\"\n    },\n    {\n      \"language\": \"sql\",\n      \"command\": \"-- 2) Create archive table (Postgres)\\nCREATE TABLE IF NOT EXISTS container_archive (LIKE container INCLUDING ALL);\"\n    },\n    {\n      \"language\": \"sql\",\n      \"command\": \"-- 3) Identify older rows and move to archive, then delete (Postgres safe sequence)\\nBEGIN;\\nWITH dup AS (\\nSELECT id, row_number() OVER (PARTITION BY cntr_no ORDER BY snapshot_ts DESC, id DESC) rn\\nFROM container\\nWHERE cntr_no='CMAU0000020'\\n)\\nINSERT INTO container_archive SELECT c.* FROM container c JOIN dup d ON c.id=d.id WHERE d.rn>1;\\nDELETE FROM container WHERE id IN (SELECT id FROM dup WHERE rn>1);\\nCOMMIT; -- preserves the most recent snapshot only per [KB-2210]\"\n    },\n    {\n      \"language\": \"sql\",\n      \"command\": \"-- 4) Verify single live row remains\\nSELECT cntr_no, id, snapshot_ts, created_at FROM container WHERE cntr_no='CMAU0000020' ORDER BY snapshot_ts DESC; -- should return exactly 1 row\"\n    },\n    {\n      \"language\": \"bash\",\n      \"command\": \"-- Backup container table (Postgres example)\\npg_dump -t public.container mydatabase > /var/backups/container_backup_ALR-861600_$(date +%Y%m%d%H%M%S).sql\"\n    },\n    {\n      \"language\": \"bash\",\n      \"command\": \"-- Inspect application logs for duplicate warnings\\ngrep \\\"DuplicateSnapshotAttempt\\\" /var/log/container_service/container_service.log | grep CMAU0000020 || true\"\n    },\n    {\n      \"language\": \"api\",\n      \"command\": \"-- Example cache invalidation API call (replace token/host with internal values)\\ncurl -X POST \\\"https://internal-api.local/internal/cache/invalidate\\\" -H \\\"Authorization: Bearer ${INTERNAL_API_TOKEN}\\\" -H \\\"Content-Type: application/json\\\" -d '{\\\"cntr_no\\\":\\\"CMAU0000020\\\"}'\"\n    },\n    {\n      \"language\": \"bash\",\n      \"command\": \"-- Alternative: restart cache consumer service if API not available (run on service host)\\nsudo systemctl restart container-cache.service && sudo journalctl -u container-cache.service --since \\\"1 minute ago\\\" --no-pager\"\n    }\n  ],\n  \"checklists\": [\n    {\n      \"title\": \"Pre-change checklist\",\n      \"items\": [\n        \"Backup of container table created and checksum recorded\",\n        \"Maintenance window/low-activity confirmed with yard ops\",\n        \"Access rights validated (DB admin credentials available)\",\n        \"Incident record includes log excerpts evidencing the DuplicateSnapshotAttempt\"\n      ]\n    },\n    {\n      \"title\": \"Post-change verification checklist\",\n      \"items\": [\n        \"SELECT shows exactly one live snapshot for CMAU0000020\",\n        \"Archived table contains the older snapshot rows with timestamps and IDs\",\n        \"Application logs show no new DuplicateSnapshotAttempt entries post-change\",\n        \"Downstream APIs/GUI reflect corrected inventory view for CMAU0000020\",\n        \"Backup and SQL statements used are attached to incident evidence (location + checksum)\"\n      ]\n    },\n    {\n      \"title\": \"Ready to close\",\n      \"items\": [\n        \"All verification checklist items completed and evidence attached\",\n        \"Stakeholders (Yard Duty Officer and ops) notified by email with summary and links\",\n        \"Incident ALR-861600 updated with actions, KB reference [KB-2210], and closure note\",\n        \"No further duplicate attempts detected for CMAU0000020 for the monitoring retention window\"\n      ]\n    }\n  ]\n}",
      "module": "CNTR",
      "expectedOutcome": null,
      "results": {
        "procedureCompliance": {
          "score": 70,
          "issues": [
            "Missing required step: validate container status",
            "Missing required step: check location data",
            "Missing required step: verify ownership"
          ],
          "category": "procedure_compliance"
        },
        "accuracyCheck": {
          "score": 85,
          "issues": [
            "Missing container status check"
          ],
          "category": "accuracy"
        },
        "safetyValidation": {
          "score": 75,
          "issues": [
            "Missing safety consideration: proper documentation"
          ],
          "category": "safety"
        },
        "completenessCheck": {
          "score": 100,
          "issues": [],
          "category": "completeness"
        },
        "clarityScore": {
          "score": 100,
          "issues": [],
          "category": "clarity"
        }
      },
      "overallScore": 86,
      "passed": true
    }
  },
  "summary": {
    "totalTests": 12,
    "passedTests": 12,
    "failedTests": 0,
    "avgAccuracy": 87,
    "lastRun": "2025-10-19T10:09:57.287Z"
  }
}